# אפיון הודעת הסיכום החודשי בטלגרם

## מה נשלח
- הודעת טלגרם אחת לכל משתמש מחובר לבוט עם סיכום פעילות החודש הקודם.
- ברירת מחדל: טקסט שנוצר עם GPT (`get_monthly_summary_text_with_gpt` מתוך `app/routes/statistics_routes.py`), עם גיבוי ידני אם יש כשל ב-GPT (`get_monthly_summary_text_fallback`).
- הפנייה לנתוני המשתמש בלבד; אין טקסט שיווקי קבוע.
- נשלח כ-`Markdown` באמצעות `bot.send_message` ב-`telegram_bot.py`.

## טריגר ושליחה (תזמון)
- ריצה מתוך הסקריפט `schedule_daily_reminder` ב-`telegram_bot.py` אחת ליום:
  - טוען הגדרות מ-`bot_settings` בטבלה `key/value` (`reminder_hour`, `reminder_minute`, `monthly_summary_day`, `last_monthly_summary_sent`).
  - ברירת מחדל: שעה 10:00 (REMINDER_HOUR/MINUTE) ויום חודשי הוא ראשון בחודש המחושב (first Sunday), אך יש תיקון חד־פעמי שמעדכן ל־20 בחודש בעת הפעלת הבוט (`update_monthly_summary_day_to_20`).
  - שולח רק אם היום מתאים ל-`monthly_summary_day`, השעה המתוכננת ±0–30 דקות, וה-`last_monthly_summary_sent` שונה מהיום הנוכחי.
  - אחרי שליחה מעדכן `last_monthly_summary_sent` ומחשב מחדש את יום ראשון של החודש הבא אם עובדים במצב "יום ראשון".
- נמענים: כל הרשומות ב-`telegram_users` עם `is_verified=true`, `telegram_chat_id` לא ריק ו-`verification_expires_at > NOW()`. אין כרגע בדיקת opt-out של `users.telegram_monthly_summary`.
- פקודות ניהול:
  - `/test_monthly` שולחת מיד את הסיכום למנהל המחובר (אימות+בדיקת אדמין).
  - `/change_monthly_day <יום/\"ראשון\">` לעדכון יום השליחה, כולל מצב "יום ראשון הראשון" של החודש הבא.

## חישוב הנתונים לחודש המדווח (`calculate_monthly_statistics`)
- החודש המדווח הוא החודש הקודם להרצה (נקבע ב-`send_monthly_summary`).
- טווחי תאריכים: מה-1 בחודש ועד ה-1 של החודש הבא (UTC של Postgres).
- נתונים בסיסיים:
  - `new_coupons_count`: כל הקופונים שנוספו בטווח.
  - `used_new_coupons_count`: קופונים שנוספו בטווח והסטטוס שלהם `נוצל`.
  - `total_savings`: סכום (`value - cost`) לקופונים שהתווספו בטווח, סטטוס `פעיל`, ואינם מסומנים `exclude_saving`.
  - `average_savings`: `total_savings / new_coupons_count` (אם יש לפחות קופון אחד).
  - `total_active_value`: סכום יתרות (`value - used_value`) לכל הקופונים הפעילים של המשתמש (לא למכירה, לא מסומנים exclude_saving=true), ללא קשר לטווח התאריכים.
- שימוש:
  - `total_coupons`: כל הקופונים שנוספו בטווח.
  - `fully_used`: קופונים בטווח עם `used_value >= value`.
  - `partially_used`: `0 < used_value < value`.
  - `unused`: חישוב משלים.
  - `usage_percentage`: `fully_used / total_coupons` * 100.
- חברות פופולריות (Top 5):
  - סכימת שימושים מ-`CouponUsage` (ידני, מסנן רשומות Multipass) ומ-`CouponTransaction` (שימושים אוטומטיים עם `usage_amount > 0`) בטווח.
  - מאחד וממיין לפי ספירת שימושים; מחזיר רשימה של `{name, usage_count}`.
- התראות תפוגה:
  - סופר קופונים פעילים עם יתרה חיובית שתאריך התפוגה שלהם בחודש הבא של החודש המדווח.
  - מחזיר `expiring_next_month` ומערך `expiring_companies`.
- השוואה לחודש קודם:
  - `prev_month_coupons`, `prev_month_savings` באותו חישוב כמו הנוכחי אבל על החודש שלפני המדווח.
  - `coupons_change` / `savings_change` הם דלתא לעומת החודש הקודם.

## בניית טקסט עם GPT (`get_monthly_summary_text_with_gpt`)
- מקבל `user_id`, `month`, `year`, `user_gender`:
  - טוען שם פרטי ושם חודש עברי.
  - מחשב יחס שימוש בקופונים חדשים (`usage_percentage`) ופרונאונס לפי מין (`אתה/את`, `תמשיך/תמשיכי`, אימוג'י שף מגדרי).
- מייצר `base_data` עם כל המספרים המפורטים לעיל + הנחיות תוכן:
  - ניסוח ערך פעיל: "סה\"כ [סכום] ש\"ח בקופונים" / "יש לך [סכום] ש\"ח בקופונים".
  - להזכיר קופונים שפגים בחודש הבא רק אם קיימים; לא להזכיר קופונים שפג תוקפם.
  - להתמקד רק בנתוני המשתמש, ללא שיווק קבוע.
- בוחר אקראית אחד מ-5 פרומפטים (כולם עד ~120 מילים, עברית בלבד):
  1. חברותי ומעודד – פתיח "📆 סיכום …" או "היי …", טון חם, משפט ניצול חובה: "ניצלת X קופונים מתוך Y… - Z%!!", סיום "{תמשיך/תמשיכי} ככה! כל הכבוד 💪".
  2. יצירתי ומאופק – פתיח "🎨 … בסקיצה" או "📊 הפלטה של …", מטפורות עיצוב, משפט ניצול "סקצת X…", סיום "{תמשיך/תמשיכי} לעצב את החיסכון שלך 🎨".
  3. שמח ומתלהב – פתיח "🎉 וואו! איזה …!", יותר אמוג'י, משפט ניצול "… Z%! מדהים! 🔥", סיום "{תמשיך/תמשיכי} להיות כוכב החיסכון! 🌟✨".
  4. הומוריסטי וקליל – פתיח "😄 החשבון של … הגיע!", משפט ניצול עם בדיחה "(יש מקום לשיפור, אבל מי ספר?)", סיום "{תמשיך/תמשיכי} לחסוך כמו שף! 👨‍🍳/👩‍🍳💰".
  5. מוטיבציוני – פתיח "💪 {שם}, … היה חודש של הישגים!", משפט ניצול מחזק, סיום "כל יום הוא הזדמנות חדשה… {תמשיך/תמשיכי} חזק! 🚀".
- קריאה ל-`openai.ChatCompletion` עם `model="gpt-4o-mini"`, `temperature=0.7`, `max_tokens=500`. אם הצליח מחזיר את הטקסט ומדפיס לוג שימוש.

## הודעת גיבוי (`get_monthly_summary_text_fallback`)
- בנויה ידנית אם GPT נכשל:
  - כותרת: "📆 סיכום {חודש} 📆".
  - ברכה עם שם פרטי.
  - משפט ניצול: "ניצלת {used_new}… - {percent_used}%!! 👏".
  - חיווי אחוז ניצול כולל (`usage_percentage`) בטון מותאם (מעל 70/40/0).
  - אם יש ערך פעיל: "יש לך סה\"כ ₪X בקופונים!".
  - אם יש חברות פופולריות: מציין את המובילה.
  - התראת תפוגה לחודש הבא: ניסוח שונה ל-1 קופון / כמה, כולל שמות חברות ראשונות; אחרת מציין שאין קופונים פגי תוקף בחודש הבא.
  - סגירה מגדרית: "תמשיכי/תמשיך ככה! כל הכבוד 💪".

## נקודות תצורה ותלויות
- סביבת עבודה: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_BOT_USERNAME`, `ENABLE_BOT`, `API_URL`, `SESSION_TIMEOUT_MINUTES`, `REMINDER_HOUR/MINUTE`, `OPENAI_API_KEY`, `ENCRYPTION_KEY`.
- שמירת הגדרות תזמון בטבלת `bot_settings` (נוצרת אוטומטית אם לא קיימת).
- שליחה מתבצעת רק אם `context_app` קיים (האפליקציה של הבוט רצה). אם הבוט מושבת (Python 3.13 או `ENABLE_BOT=false`) לא יישלחו סיכומים.
- העדפת משתמש `users.telegram_monthly_summary` נשמרת דרך `/profile/preferences` אך אינה נבדקת כרגע במסלול השליחה.
