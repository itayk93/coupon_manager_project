# הוראות Deploy ב-Render עבור מערכת ניהול קופונים

## סקירה כללית

מערכת ניהול הקופונים שופרה לעבודה ב-Render עם תמיכה ב:

- ✅ **Web Service** - אפליקציית Flask עם Selenium
- ✅ **Worker Service** - עיבוד רקע של עדכוני קופונים
- ✅ **Cron Jobs** - עדכון אוטומטי יומי
- ✅ **Redis** - תור משימות רקע
- ✅ **PostgreSQL** - בסיס נתונים

## 🚀 השיפורים שנוספו

### 1. Progress Bar מתקדם
- מעקב בזמן אמת על עדכון קופונים
- סטטוס מפורט לכל קופון
- ספירת הצלחות/כשלונות
- אפשרות ביטול תהליך

### 2. Retry Mechanism
- 3 ניסיונות לכל קופון
- Exponential backoff (5, 10, 15 שניות)
- לוגים מפורטים לכל ניסיון

### 3. Logging מתקדם
- קובץ לוג נפרד: `logs/multipass_updates.log`
- זמני ביצוע לכל פעולה
- מעקב אחר הצלחות/כשלונות
- אמוג'ים לזיהוי מהיר

### 4. Background Tasks
- עיבוד אסינכרוני עם Redis Queue
- מתאים לכמויות גדולות של קופונים
- polling אוטומטי לסטטוס המשימה
- fallback לעיבוד סינכרוני

### 5. תשתית Render
- Docker container עם Chrome ו-Selenium
- Worker service נפרד
- Cron job יומי ב-3:00 בבוקר UTC
- Redis ו-PostgreSQL מנוהלים

## 📋 מדריך Deploy

### שלב 1: הכנת הריפו ב-GitHub

```bash
# Clone הפרויקט
git clone <repository-url>
cd coupon_manager_project

# וידוא שכל הקבצים החדשים נמצאים
ls -la
# אמור להיות: Dockerfile, render.yaml, app/tasks.py, scripts/daily_update.py
```

### שלב 2: יצירת שירותים ב-Render

1. **התחבר ל-Render Dashboard**
2. **לחץ על "New" ובחר "Blueprint"**
3. **חבר את הריפו GitHub**
4. **Render יזהה את קובץ render.yaml ויצור אוטומטית:**
   - Redis Service (Free)
   - PostgreSQL Database (Free)
   - Web Service (Free)
   - Worker Service (Starter Plan - $7/month)
   - Cron Job (Starter Plan)

### שלב 3: הגדרת משתני סביבה

המשתנים הבאים יוגדרו אוטומטית על ידי render.yaml:

```
DATABASE_URL=<auto-generated>
REDIS_URL=<auto-generated>
SECRET_KEY=<auto-generated>
FLASK_ENV=production
CHROME_BIN=/usr/bin/google-chrome
CHROMEDRIVER_PATH=/usr/local/bin/chromedriver
SELENIUM_HEADLESS=true
```

**משתנים נוספים שצריך להוסיף ידנית:**

```
GOOGLE_CLIENT_ID=<your-google-oauth-client-id>
GOOGLE_CLIENT_SECRET=<your-google-oauth-client-secret>
SENDINBLUE_API_KEY=<your-sendinblue-api-key>
TELEGRAM_BOT_TOKEN=<your-telegram-bot-token>
FLASK_SECRET_KEY=<same-as-secret-key>
```

### שלב 4: הגדרת URLs והתאמות

1. **עדכן Redirect URLs ב-Google OAuth Console:**
   ```
   https://your-app-name.onrender.com/auth/google/callback
   ```

2. **עדכן Webhook ב-Telegram:**
   ```
   https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=https://your-app-name.onrender.com/telegram/webhook
   ```

## 🔧 הפעלה מקומית (לפיתוח)

```bash
# הגדרת סביבת פיתוח
python -m venv venv
source venv/bin/activate  # Linux/Mac
# או
venv\Scripts\activate     # Windows

# התקנת dependencies
pip install -r requirements.txt

# הפעלת Redis מקומי (אופציונלי)
redis-server

# הפעלת Worker (אופציונלי)
python -m app.tasks

# הפעלת האפליקציה
python app.py
```

## 🎛️ תכונות חדשות בממשק

### כפתור עדכון קופונים
- **עד 5 קופונים**: עיבוד מיידי (כחול)
- **יותר מ-5 קופונים**: עיבוד רקע (ירוק)

### Progress Bar
- מעקב בזמן אמת
- מידע על הקופון הנוכחי
- ספירת הצלחות/כשלונות
- אפשרות ביטול

### מעקב Background Jobs
- Polling אוטומטי כל 30 שניות
- התראות על השלמה
- עדכון דף אוטומטי

## 🚨 בעיות נפוצות וכיצד לפתור

### 1. Worker לא מתחיל

**בעיה**: Worker service נכשל
**פתרון**: 
- וידוא שה-plan הוא Starter (לא Free)
- בדיקת logs: `REDIS_URL` מוגדר נכון

### 2. Chrome לא עובד

**בעיה**: Selenium נכשל
**פתרון**:
- וידוא שמשתני הסביבה מוגדרים:
  ```
  CHROME_BIN=/usr/bin/google-chrome
  CHROMEDRIVER_PATH=/usr/local/bin/chromedriver
  SELENIUM_HEADLESS=true
  ```

### 3. Background Tasks לא עובדים

**בעיה**: המערכת נופלת לעיבוד סינכרוני
**פתרון**:
- בדיקה שRedis פעיל
- בדיקה שWorker רץ
- בדיקת logs של Worker

### 4. Database Migration

```bash
# אם צריך להריץ migrations ידנית
flask db upgrade
```

## 📊 מעקב וניטור

### לוגים חשובים
- **Web Service**: `/logs/multipass_updates.log`
- **Worker Service**: Render logs dashboard
- **Cron Job**: Render logs dashboard

### מדדי ביצועים
- זמני תגובה של עדכון קופונים
- שיעור הצלחה/כשלון
- מספר קופונים שעודכנו ביום

### מעקב בזמן אמת
```bash
# בדיקת Redis queue
redis-cli monitor

# בדיקת Worker status
curl https://your-app.onrender.com/job_status/<job_id>
```

## 💰 עלויות Render

- **Web Service**: Free (עד 750 שעות/חודש)
- **PostgreSQL**: Free (עד 1GB)
- **Redis**: Free (עד 25MB)
- **Worker Service**: $7/חודש (Starter)
- **Cron Jobs**: כלול ב-Starter plan

**סה"כ**: ~$7/חודש עבור פונקציונליות מלאה

## 🔄 עדכונים עתידיים

הקוד מוכן לשיפורים נוספים:

1. **Webhook Notifications** - התראות על השלמת עדכונים
2. **API Integration** - מעבר מ-Selenium ל-APIs רשמיים
3. **Monitoring Dashboard** - דשבורד ניטור מתקדם
4. **Auto-scaling** - התאמה אוטומטית לעומס

---

**הערה**: המערכת תעבוד גם בלי Worker Service (עיבוד סינכרוני), אבל מומלץ מאוד להשתמש ב-Worker לביצועים מיטביים.

🎉 **המערכת מוכנה לעבודה ב-production!**