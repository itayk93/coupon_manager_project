<!-- index.html -->
{% extends 'base.html' %}

{% block title %}ניהול קופונים דיגיטליים חכם - Coupon Master{% endblock %}

{% block content %}
<!-- Add Shepherd.js CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

<!-- Admin flash message -->
{% if show_admin_message and admin_message %}
<div class="admin-flash-message">
    <p>{{ admin_message.message_text | replace("\n", "<br>") | safe }}</p>
    {% if admin_message.link_url %}
        <a href="{{ admin_message.link_url }}" target="_blank" class="admin-message-button">
            {{ admin_message.link_text if admin_message.link_text else "למידע נוסף" }}
        </a>
    {% endif %}
    <form method="post" action="{{ url_for('admin_messages_bp.dismiss_admin_message') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="close-button">×</button>
    </form>
</div>
{% endif %}

<section class="hero">
    <!-- Hidden H1 for SEO keywords -->
    <h1 style="display:none;">קופונים והנחות בלעדיות בישראל - חסוך כסף עכשיו!</h1>
    <h2>{{ greeting }}, {{ current_user.first_name }}!</h2>

    {% if show_expiring_alert %}
    <!-- Alert for expiring coupons -->
    <div class="expiring-coupons-alert">
        <!-- Close alert button -->
        <a class="close-expiring-alert" href="{{ url_for('profile.dismiss_expiring_alert') }}">×</a>
        <p><strong>שים לב!</strong> יש לך {{ expiring_coupons|length }} קופונים שעומדים לפוג תוקפם בשבוע הקרוב:</p>
        <ul class="expiring-coupons-list">
            {% for c in expiring_coupons %}
            <li>
                <strong>{{ c.company }}</strong> -
                {% set expiration_date = c.expiration.strftime('%d/%m/%Y') %}
                {% set today_date = current_date.strftime('%d/%m/%Y') %}
                {% set tomorrow_date = (current_date + timedelta(days=1)).strftime('%d/%m/%Y') %}
                {% if expiration_date == today_date %}
                    התוקף יפוג היום בלילה
                {% elif expiration_date == tomorrow_date %}
                    התוקף יפוג מחר
                {% else %}
                    התוקף יפוג ב-<strong>{{ expiration_date }}</strong>
                {% endif %}
                <span class="coupon-button-wrapper">
                    <a class="view-coupon-button" href="{{ url_for('coupons.coupon_detail', id=c.id) }}">
                        צפה בקופון
                    </a>
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="total-value">
        <p>נשאר לך בארנק:</p>
        <h1>{{ '%.2f'|format(total_value) }} ₪</h1>
    </div>

    <!-- תוכן נסתר ל-SEO מותאם לניהול קופונים -->
    <div class="hidden-seo-content" style="display:none;">
      <h1>אפליקציית ניהול קופונים דיגיטליים - Coupon Master</h1>
      <p>אתם קונים קופונים דיגיטליים ומתקשים לעקוב אחריהם? <strong>Coupon Master</strong> הוא הפתרון המושלם לניהול כל הקופונים הדיגיטליים שלכם במקום אחד. האפליקציה עוקבת אחר יתרות הקופונים, שולחת התראות לפני תפוגת תוקף ומציגה סטטיסטיקות מפורטות על החסכון שלכם.</p>
      
      <h2>למה כדאי להשתמש באפליקציית ניהול קופונים?</h2>
      <ul>
        <li><strong>מעקב אחר כל הקופונים הדיגיטליים במקום אחד</strong> - לא עוד חיפוש בין אפליקציות שונות</li>
        <li><strong>חישוב אוטומטי של יתרות קופונים</strong> - תמיד לדעת כמה כסף נשאר לכם בארנק</li>
        <li><strong>התראות על תפוגת תוקף</strong> - קבלו התראות 30, 7 ויום לפני שהקופון פג</li>
        <li><strong>מעקב אחר שימוש חלקי בקופונים</strong> - מושלם לקופוני חנויות שמשתמשים בהם מספר פעמים</li>
        <li><strong>סטטיסטיקות חסכון מפורטות</strong> - ראו בדיוק כמה כסף חסכתם ועל מה</li>
        <li><strong>ארגון לפי חברות ותגים</strong> - מיון חכם של הקופונים שלכם</li>
      </ul>

      <h2>איך עובדת אפליקציית ניהול הקופונים?</h2>
      <p>עם <strong>Coupon Master</strong> תוכלו להכניס בקלות את כל הקופונים הדיגיטליים שלכם - קופוני BuyMe, כרטיסי מתנה, קופוני חנויות ועוד. המערכת תעקוב אחר הערך הנותר של כל קופון ותזכיר לכם להשתמש בהם לפני שהם פגים.</p>

      <h2>למי מתאימה האפליקציה?</h2>
      <p>האפליקציה מתאימה לכל מי שיש לו הרבה קופונים דיגיטליים ורוצה לנהל אותם בצורה מקצועית וחכמה. במיוחד מתאים לאנשים שקונים הרבה קופונים במבצעים ורוצים לוודא שהם משתמשים בהם במועד.</p>
    </div>
    
    <!-- Statistics and Quick Add buttons -->
    <div style="display: flex; justify-content: center; gap: 15px;">
        <button id="open-stats-modal" class="stats-button">
            <i class="fas fa-chart-bar"></i> על מה חסכת?
        </button>
        <button id="openUsageModalBtn" class="stats-button report-usage-button">
            <i class="fas fa-plus-circle"></i> דיווח מהיר על שימוש
        </button>
        <button id="quick-add-coupon-btn" class="stats-button quick-add-button">
            <i class="fas fa-plus"></i> הוספת קופון מהירה
        </button>
    </div>
</section>



<!-- Company cards row -->
<div id="company-cards-row" class="company-cards-row"></div>

<!-- מכיל את המודל - ייטען דינמית -->
<div id="usageModalContainer"></div>

<!-- Coupon list section -->
<section class="coupon-list">
    {% macro get_company_logo(coupon) %}
        {% set company_lower = coupon.company.lower() %}
        <img src="{{ url_for('static', filename=company_logo_mapping.get(company_lower, 'images/default.png')) }}"
             alt="{{ coupon.company }} Logo" class="company-logo">
    {% endmacro %}

    {% set coupon_categories = [
        (active_coupons, "קופונים פעילים"),
        (active_one_time_coupons, "קופונים חד פעמיים"),
        (coupons_for_sale, "קופונים למכירה")
    ] %}
    {% for coupons, title in coupon_categories %}
        {% if coupons %}
            <h3 class="coupon-section-title">{{ title }}</h3>
            <div class="coupon-container-index">
                {% for coupon in coupons %}
                <!-- NEW COUPON CARD STRUCTURE -->
                <div class="coupon-card-index-wrapper"
                     data-company="{{ coupon.company }}"
                     data-coupon-code="{{ coupon.code }}"
                     data-coupon-id="{{ coupon.id }}"
                     data-remaining="{{ '%.2f'|format(coupon.remaining_value) }}"
                     data-logo-src="{{ url_for('static', filename=company_logo_mapping.get(coupon.company|lower, 'images/default.png')) }}"
                     {% if coupon.is_one_time %}
                         data-is-one-time="true" data-purpose="{{ coupon.purpose }}"
                     {% else %}
                         data-is-one-time="false"
                     {% endif %}
                     {% if coupon.cvv %}
                         data-coupon-cvv="{{ coupon.cvv }}"
                     {% endif %}
                     {% if coupon.card_exp %}
                         data-coupon-card-index-exp="{{ coupon.card_exp }}"
                     {% endif %}>
                    <div class="coupon-card-index">
                        <div class="coupon-header">
                            <img src="{{ url_for('static', filename=company_logo_mapping.get(coupon.company|lower, 'images/default.png')) }}" 
                                 alt="{{ coupon.company }} Logo" class="company-logo">
                            <h4>{{ coupon.company }}</h4>
                        </div>
                        
                        <div class="coupon-content">
                            <div class="coupon-code">
                                <span class="label">קוד קופון:</span>
                                <span class="value">{{ coupon.code }}</span>
                            </div>
                            
                            {% if coupon.is_one_time %}
                            <div class="coupon-purpose">
                                <span class="label">מטרה:</span>
                                <span class="value">{{ coupon.purpose }}</span>
                            </div>
                            {% else %}
                            <div class="coupon-value">
                                <span class="label">יתרה:</span>
                                <span class="value">{{ '%.2f'|format(coupon.remaining_value) }} ₪</span>
                            </div>
                            
                            <div class="usage-progress">
                                <div class="progress-text">
                                    {% if coupon.value > 0 %}
                                      שימוש: {{ (coupon.used_value / coupon.value * 100)|round(0)|int }}%
                                    {% else %}
                                      שימוש: 0%
                                    {% endif %}
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {% if coupon.value > 0 %}{{ (coupon.used_value / coupon.value * 100)|round(2) }}{% else %}0.0{% endif %}%"></div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if title == "קופונים למכירה" %}
                            <div class="sale-price">
                                <span class="label">מחיר מכירה:</span>
                                <span class="value" style="color: var(--accent-color);">{{ '%.2f'|format(coupon.cost) }} ₪</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="coupon-actions">
                            <a href="{{ url_for('coupons.coupon_detail', id=coupon.id) }}" class="action-button view-details">
                                <i class="fas fa-info-circle"></i>
                                <span>פרטים</span>
                            </a>
                            <button class="action-button show-code">
                                <i class="fas fa-eye"></i>
                                <span>הצג קוד</span>
                            </button>
                            {% if not coupon.is_one_time %}
                            <button class="action-button update-usage">
                                <i class="fas fa-edit"></i>
                                <span>עדכן שימוש</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endfor %}
</section>

<!-- Modal Container - Will be filled dynamically -->
<div id="couponModalsContainer"></div>

<!-- Stats Modal Container - Will be populated dynamically -->
<div id="statsModal" class="modal"></div>

<!-- Quick Add Coupon Modal Container -->
<div id="quickAddCouponModal" class="modal"></div>

<div class="export-buttons">
    <a href="{{ url_for('export.export_excel') }}" class="export-button">
        <i class="fas fa-file-excel" aria-hidden="true"></i> ייצא ל-Excel
    </a>
    <a href="{{ url_for('export.export_pdf') }}" class="export-button">
        <i class="fas fa-file-pdf" aria-hidden="true"></i> ייצא ל-PDF
    </a>
</div>

{% if current_user.is_admin %}
<form action="{{ url_for('coupons.update_all_active_coupons') }}" method="post"
      style="text-align: center; margin-top: 40px; margin-bottom: 20px;">
    {{ usage_form.hidden_tag() }}
    <button type="submit" class="action-button small-button multipass-update-button">
      <i class="fa fa-refresh"></i> עדכן את כל הקופונים הפעילים מ-Multipass
  </button>
</form>
{% endif %}

<!-- Hidden data for statistics -->
<div id="stats-data" style="display: none;" 
    data-companies-stats='{{ companies_stats|safe }}' 
    data-timeline-data='{{ timeline_data|safe }}'
    data-total-savings='{{ total_savings }}'
    data-total-coupons-value='{{ total_coupons_value }}'
    data-percentage-savings='{{ percentage_savings }}'
    data-total-coupons-count='{{ total_coupons_count }}'
    data-active-coupons-count='{{ active_coupons_count if active_coupons_count is defined else "0" }}'
    data-average-usage-percentage='{{ average_usage_percentage }}'>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tooltip.css') }}">

<!-- ADDED: Chart.js library for statistics -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!-- ADDED: QR Code library for coupon display -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
/* ===== General Styles and Notifications ===== */
.admin-flash-message {
    background-color: #fff8e1;
    color: #856404;
    border: 1px solid #ffeeba;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 1em;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin: 15px auto;
    max-width: 800px;
    width: 90%;
    position: relative;
}
.admin-flash-message .close-button {
    position: absolute;
    top: 8px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.1em;
    cursor: pointer;
    color: inherit;
}
.admin-message-button {
    display: inline-block;
    background-color: #3498db;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 0.85em;
    font-weight: bold;
    transition: background 0.3s ease-in-out;
    margin-top: 2px;
}
.admin-message-button:hover {
    background-color: #2980b9;
}

/* Expiring coupons alert */
.expiring-coupons-alert {
    background-color: #fff8e1;
    color: #000;
    padding: 15px 20px;
    border-radius: 8px;
    font-size: 1.1em;
    position: relative;
    margin-top: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: center;
}
.close-expiring-alert {
    position: absolute;
    top: 5px;
    right: 10px;
    font-size: 1.2em;
    text-decoration: none;
    color: #ff9800;
    font-weight: bold;
}
.expiring-coupons-list {
    list-style: none;
    margin: 10px 0 0;
    padding: 0;
}
.expiring-coupons-list li {
    margin-bottom: 5px;
}
.coupon-button-wrapper {
    display: inline;
}

/* Coupon view button */
.view-coupon-button {
    display: inline-block;
    margin-right: 5px;
    background-color: #3498db;
    color: #fff;
    text-decoration: none;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.9em;
    font-weight: normal;
}
.view-coupon-button:hover {
    background-color: #2980b9;
}

/* ===== Titles and Amounts ===== */
.total-value p {
    font-size: 1.25em;
    font-weight: bold;
}
.hidden-text {
    display: none;
}
.total-value {
    background-color: var(--white);
    padding: 20px 0px;
    margin: 25px auto;
    border-radius: 10px;
    border: 1px solid var(--light-gray);
    width: 350px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.total-value p {
    font-size: 1em;
    color: var(--text-color);
    margin-bottom: 10px;
    text-align: center;
}

.total-value h1 {
    font-size: 3em;
    margin: 0 auto;
    color: var(--success-color);
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 0.3em;
}
/* ===== Company Cards Row ===== */
.company-cards-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin: 20px auto 30px auto;
    max-width: 1000px;
}
.company-card-box {
    background-color: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    width: 200px;
    text-align: center;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.company-card-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.company-card-box img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    margin-bottom: 10px;
}
.company-card-box h3 {
    margin: 0;
    font-size: 1.1em;
    font-weight: bold;
    color: #333;
}
.company-card-box p {
    margin: 5px 0;
    font-size: 0.9em;
    color: #666;
}
@media (max-width: 450px) {
    .company-cards-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 0 10px;
    }
    .company-card-box {
        width: 100%;
    }
    .company-card-box:nth-child(odd):last-child {
        grid-column: 1 / -1;
        justify-self: center;
        width: 50%;
    }
}

/* ===== Forms (Usage Report / Add Coupon) ===== */
/* ===== Forms Container & Responsiveness ===== */
.usage-forms-container {
    display: flex;
    gap: 20px; /* # Increased gap between forms for better spacing */
    justify-content: center;
    align-items: stretch;
    margin: 30px auto; /* # Increased vertical margin */
    max-width: 800px;
    width: 90%; /* # Added width control for smaller screens */
    padding: 10px; /* # Added padding to prevent content touching edges */
}

.usage-form-wrapper {
    flex: 1;
    background-color: #fff; /* # Added background color */
    border-radius: 10px; /* # Rounded corners */
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); /* # Subtle shadow for depth */
    border: 1px solid #e6e6e6; /* # Light border */
    padding: 20px; /* # Added internal padding */
    transition: transform 0.2s ease, box-shadow 0.2s ease; /* # Smooth hover effect */
}

.usage-form-wrapper:hover {
    transform: translateY(-3px); /* # Slight lift effect on hover */
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* # Enhanced shadow on hover */
}

.usage-form-wrapper form {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.input-wrapper {
    margin-bottom: 15px; /* # Increased margin */
}

.input-wrapper label {
    display: block;
    margin-bottom: 8px; /* # Added space after label */
    font-weight: bold; /* # Made label bold for emphasis */
    color: #444; /* # Slightly darker than black for easier reading */
}

.input-field_centered {
    width: 100%;
    padding: 12px; /* # Increased padding for better touch targets */
    border: 1px solid #ddd;
    border-radius: 6px; /* # Rounded input field */
    resize: vertical; /* # Allow vertical resizing only */
    font-family: inherit; /* # Consistent font */
    transition: border-color 0.2s ease; /* # Smooth focus transition */
    direction: rtl; /* # Keep RTL text direction for Hebrew */
    text-align: center; /* # Center-align text instead of right-align */
}

/* # Ensure placeholder text is also centered */
.input-field_centered::placeholder {
    direction: rtl;
    text-align: center;
}

/* # Handle all browser variations of placeholder */
.input-field_centered::-webkit-input-placeholder {
    direction: rtl;
    text-align: center;
}
.input-field_centered::-moz-placeholder {
    direction: rtl;
    text-align: center;
}
.input-field_centered:-ms-input-placeholder {
    direction: rtl;
    text-align: center;
}
.input-field_centered:-moz-placeholder {
    direction: rtl;
    text-align: center;
}

.input-field_centered:focus {
    border-color: var(--primary-color, #3498db); /* # Highlight border on focus */
    outline: none; /* # Remove default focus outline */
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); /* # Subtle focus glow */
}

/* # Container for button and tooltip */
.button-with-explanation {
    display: flex;
    flex-direction: row; /* # Explicit direction */
    align-items: center;
    margin-top: auto; /* # Push to bottom of container */
    position: relative; /* # Important for tooltip positioning */
}

/* # Place tooltip button first (on the right in RTL) */
.tooltip-button-mobile {
    background: none;
    border: 1px solid #ddd;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-left: 10px; /* # Space between tooltip and button */
    order: 1; /* # First in visual order (right side in RTL) */
    position: relative; /* # Important for tooltip positioning */
}

.tooltip-button-mobile:hover {
    background-color: #f5f5f5;
}

/* # Submit button follows the tooltip button */
.submit-button {
    background-color: var(--primary-color, #3498db);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
    width: 120px; /* # Fixed width for consistent sizing */
    order: 2; /* # Second in visual order */
}

.submit-button:hover {
    background-color: var(--primary-hover, #2980b9); /* # Darker shade on hover */
}

/* # Tooltip Styles */
.tooltip {
    display: none;
    position: absolute;
    background-color: #333;
    color: #fff;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 0.9em;
    max-width: 250px;
    z-index: 9999;
    text-align: right; /* # Align text right for RTL */
    /* # Position from top right of the button */
    top: -5px;
    left: 30px; /* # Position to the left of the tooltip button */
    transform: translateY(-100%); /* # Move up above the button */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.tooltip::after {
    content: "";
    position: absolute;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
    top: 100%; /* # Position at the bottom of tooltip */
    right: 10px; /* # Position towards the right side for RTL */
}

.close-tooltip {
    float: left; /* # Position on left for RTL */
    cursor: pointer;
    margin-right: 8px;
}

/* # Show tooltip on hover or focus */
.tooltip-button-mobile:hover + .tooltip,
.tooltip-button-mobile:focus + .tooltip,
.tooltip:hover {
    display: block;
}

/* # Media query for mobile responsiveness */
@media (max-width: 768px) {
    .usage-forms-container {
        flex-direction: column; /* # Stack forms vertically on mobile */
        gap: 30px; /* # Increased gap between stacked forms */
    }
    
    .usage-form-wrapper {
        max-width: 100%; /* # Full width on mobile */
        width: 100%;
    }
    
    /* # Force the correct order on mobile too */
    .button-with-explanation {
        display: flex;
        flex-direction: row; /* # Keep horizontal layout */
    }
    
    .tooltip-button-mobile {
        order: 1; /* # Keep tooltip first (on right) */
    }
    
    .submit-button {
        order: 2; /* # Keep submit button second */
        width: 120px; /* # Same fixed width as desktop */
    }
    
    /* # Fix tooltip positioning for mobile */
    .tooltip {
        max-width: 200px; /* # Slightly narrower */
        font-size: 0.85em; /* # Smaller font */
        top: auto; /* # Reset top */
        bottom: 30px; /* # Position above the button */
        left: auto; /* # Reset left */
        right: 0; /* # Align to the right edge of container */
        transform: none; /* # No transform needed */
    }
    
    .tooltip::after {
        top: 100%; /* # Arrow at bottom */
        left: auto; /* # Reset left */
        right: 10px; /* # Right-aligned arrow */
    }
}

.button-with-explanation:hover .tooltip,
.tooltip-trigger:hover .tooltip {
    display: block;
}
.tooltip-button-mobile {
    margin-left: 10px;
}

/* ===== Coupon List and Cards ===== */
.coupon-container-index {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
    gap: 20px;
    margin-top: 20px;
    justify-content: center;
    grid-auto-flow: row;
    grid-template-rows: auto;
}

/* טיפול בקופון בודד בשורה במסכים גדולים */
.coupon-card-index-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
}

.coupon-card-index {
    width: 100%;
    max-width: 260px; /* רוחב מקסימלי קבוע לכל תיבת קופון */
}

@media (max-width: 992px) {
    .coupon-card-index {
        max-width: 100%; /* רוחב מלא במסכים בינוניים */
    }
}

@media (max-width: 600px) {
    .coupon-container-index {
      display: grid;
      /* שימוש ב-minmax עם רוחב מינימלי קטן יותר כדי לאפשר יותר גמישות */
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
    }
    
    /* אם יש רק קופון אחד בשורה האחרונה במסכים קטנים */
    .coupon-card-index-wrapper:last-child:nth-child(odd) {
        grid-column-start: 1;
        grid-column-end: 3;
        width: 100%;
        display: flex;
        justify-content: center;
    }
    
    .coupon-card-index-wrapper:last-child:nth-child(odd) .coupon-card-index {
        width: 100%;
        max-width: 200px; /* אותו רוחב כמו קופונים אחרים */
    }
}


.coupon-card-index-wrapper {
    overflow: visible; /* שינוי מ-hidden ל-visible */
    padding-top: 5px; /* הוספת ריפוד לאפשר את התנועה כלפי מעלה */
}


.coupon-card-index {
    background-color: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: 100%;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.coupon-card-index:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.coupon-header {
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    border-bottom: 1px solid #eee;
}

.coupon-header img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 8px;
}

.coupon-header h4 {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
    color: #333;
}

.coupon-content {
    padding: 16px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.coupon-code, .coupon-value, .sale-price {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* סגנון ספציפי עבור coupon-purpose */
.coupon-purpose {
    display: flex;
    flex-direction: column; /* מסדר את האלמנטים בעמודה */
    align-items: flex-start; /* יישור לימין */
    gap: 5px; /* מרווח בין התווית לתוכן */
}

.coupon-purpose .label {
    font-size: 0.85em;
    color: #777;
    margin-bottom: 3px; /* מרווח נוסף מתחת לתווית */
}

.coupon-purpose .value {
    width: 100%; /* הערך יתפוס את כל הרוחב */
    font-weight: 600;
    color: #333;
    word-break: break-word; /* מאפשר שבירת מילים */
}

.label {
    font-size: 0.85em;
    color: #777;
}

.value {
    font-weight: 600;
    color: #333;
}

.usage-progress {
    margin-top: 8px;
}

.progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: #666;
    margin-bottom: 4px;
}

.progress-bar {
    height: 8px;
    background-color: #eee;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: var(--primary-color, #3498db);
    border-radius: 4px;
}

.coupon-actions {
    padding: 16px;
    display: flex;
    gap: 8px;
    border-top: 1px solid #eee;
}

.action-button {
    flex: 1;
    background-color: #f5f5f5;
    color: #555;
    border: none;
    border-radius: 8px;
    padding: 8px;
    font-size: 0.75em;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: background-color 0.2s ease, color 0.2s ease;
    text-decoration: none;
}

.action-button i {
    font-size: 1em;
}

.action-button:hover {
    background-color: var(--primary-color, #3498db);
    color: #fff;
}

.view-details:hover {
    background-color: var(--secondary-color, #2ecc71);
}

.show-code:hover {
    background-color: var(--accent-color, #9b59b6);
}

.update-usage:hover {
    background-color: var(--success-color, #27ae60);
}

.coupon-section-title {
    text-align: center;
    margin-top: 30px;
    color: #444;
    font-weight: 600;
}

/* ===== Export Buttons ===== */
.export-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}
.export-button {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background-color: #2ecc71;
    color: #fff;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 5px;
}
.export-button:hover {
    background-color: #27ae60;
}

/* ===== Responsiveness ===== */
@media (max-width: 1200px) {
    .coupon-container-index {
        grid-template-columns: repeat(3, 1fr);
    }
}
@media (max-width: 992px) {
    .coupon-container-index {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width: 768px) {
    /* עיצוב מעודכן לכפתורים במסכים קטנים */
    .coupon-actions {
        flex-direction: row; /* שינוי מ-column ל-row */
        flex-wrap: wrap; /* מאפשר מעבר לשורה חדשה */
        padding: 10px;
        justify-content: space-between; /* רווח שווה בין הכפתורים */
        gap: 8px; /* מרווח בין הכפתורים */
    }
    
    /* כל הכפתורים באותו גודל */
    .coupon-actions .action-button {
        flex: 0 0 calc(50% - 4px); /* כל כפתור בשורה הראשונה תופס בדיוק חצי מהרוחב פחות המרווח */
        margin: 0; /* ביטול מרווחים מיותרים */
        padding: 6px 0;
    }
    
    /* הכפתור השלישי תופס שורה חדשה ומרוכז */
    .coupon-actions .action-button:last-child {
        flex: 0 0 calc(50% - 4px); /* בדיוק באותו גודל כמו האחרים */
        margin: 0 auto; /* מירכוז אופקי */
    }
    .action-button {
        padding: 6px 0;
    }
}
@media (max-width: 600px) {
    .coupon-container-index {
        grid-template-columns: repeat(2, 1fr); /* שני קופונים בשורה */
        gap: 8px; /* רווח קטן יותר בין הקופונים */
        padding: 0 8px; /* פדינג קטן יותר בצדדים */
        width: 100%; /* להבטיח שיתפוס את כל הרוחב */
        max-width: 100%; /* להבטיח שאין הגבלת רוחב */
        justify-content: center; /* מרכוז הקופונים */
    }
    
    .coupon-card-index-wrapper {
        width: 100%; /* להבטיח שכל קופון תופס את מלוא הרוחב של התא שלו */
    }
    
    .coupon-card-index {
        width: 100%; /* להבטיח שהכרטיס תופס את מלוא הרוחב */
    }
    
    /* הקטנת תוכן פנימי לחסוך מקום */
    .coupon-header {
        padding: 8px;
    }
    
    .coupon-header img {
        width: 45px; 
        height: 45px;
        margin-bottom: 5px;
    }
    
    .coupon-header h4 {
        font-size: 1em;
    }
    
    .coupon-content {
        padding: 8px;
        gap: 8px;
    }
    
    .label, .value {
        font-size: 0.8em;
    }
    
    .coupon-actions {
        padding: 8px;
    }
    
    .action-button {
        padding: 6px 4px;
        font-size: 0.7em;
    }
}

/* ===== Tooltip ===== */
.tooltip {
    display: none;
    position: absolute;
    background-color: #333;
    color: #fff;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 0.9em;
    max-width: 250px;
    z-index: 9999;
}
.tooltip::after {
    content: "";
    position: absolute;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
    top: 0;
    left: 10px;
    transform: translateY(-100%);
}
.close-tooltip {
    float: right;
    cursor: pointer;
    margin-left: 8px;
}

/* ===== Centering Statistics Button ===== */
.stats-button {
  background-color: #2c3e50;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 0.9em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  margin: 10px auto;
  transition: background-color 0.2s ease;
}
.stats-button:hover {
  background-color: #2980b9;
}

/* ===== Modal basic styles (minimal needed for the page) ===== */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal.active {
  opacity: 1;
  visibility: visible;
}

/* סגנון ספציפי רק לכפתור העדכון מ-Multipass */
.multipass-update-button {
  flex-direction: row;  
}

#tooltipEl {
  direction: rtl !important;
  text-align: right !important;
}

/* עבור הטולטיפים המקוריים של Chart.js */
.chartjs-tooltip {
  direction: rtl !important;
  text-align: right !important;
}

/* # Hero Section */
.hero {
    text-align: center;
    padding: 20px 15px;
    background-color: var(--white);
    margin: 15px auto;
    margin-top: 10px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    width: 55%;
    max-width: 750px;
    line-height: 1.2;
}

.hero h2 {
    margin-top: 0px;
    font-size: 2.2em;
    color: var(--primary-color);
}

.hero p {
    font-size: 1.1em;
    color: var(--text-color);
    margin-bottom: 0px;
}

/* # Total Value Display */
.total-value {
    background-color: var(--white);
    padding: 20px 0px;
    margin: 25px auto;
    border-radius: 10px;
    border: 1px solid var(--light-gray);
    width: 350px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.total-value p {
    font-size: 1em;
    color: var(--text-color);
    margin-bottom: 10px;
    text-align: center;
}

.total-value h1 {
    font-size: 3em;
    margin: 0 auto;
    color: var(--success-color);
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 0.3em;
}

/* # Hidden SEO Text */
.hidden-text {
    display: none;
}

/* # Stats Button */
.stats-button {
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.9em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin: 10px auto;
    transition: background-color 0.2s ease;
}

.stats-button:hover {
    background-color: #2980b9;
}

/* # Responsive Adjustments */
@media (max-width: 768px) {
    .hero {
        width: 90%;
        max-width: none;
        margin: 20px auto;
    }
    
    .total-value {
        width: 100%;
    }
}
/* Quick add button style */
.quick-add-button {
  background-color: #27ae60;
}
.quick-add-button:hover {
  background-color: #219653;
}
/* Add this to your CSS in index.html */
.flash-message {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 8px;
  background-color: #fff;
  color: #333;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-width: 280px;
  max-width: 400px;
  transform: translateX(110%);
  transition: transform 0.3s ease;
}

.flash-message.show {
  transform: translateX(0);
}

.flash-message.success {
  border-right: 4px solid var(--success-color);
}

.flash-message.error, .flash-message.danger {
  border-right: 4px solid var(--secondary-color);
}

.flash-message .close-flash {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  margin-right: -10px;
  margin-left: 10px;
  color: #777;
}

.flash-message .close-flash:hover {
  color: #333;
}
/* עיצוב כרטיס הדיווח החדש */
.report-usage-card {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.report-usage-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
}

.report-icon {
    background-color: var(--primary-color);
    color: white;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
}

.report-icon i {
    font-size: 30px;
}

.report-usage-card h3 {
    color: var(--primary-color);
    margin-bottom: 10px;
}

.report-usage-card p {
    color: var(--text-color);
    margin-bottom: 20px;
    font-size: 0.9em;
}

.open-modal-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: auto;
    transition: background-color 0.2s ease;
}

.open-modal-btn:hover {
    background-color: #e67e22;
}

@media (max-width: 768px) {
    .report-usage-card {
        padding: 15px;
    }
    
    .report-icon {
        width: 50px;
        height: 50px;
    }
    
    .report-icon i {
        font-size: 20px;
    }
}
/* # Style for the report usage button */
.report-usage-button {
  background-color: var(--accent-color, #e67e22);
}
.report-usage-button:hover {
  background-color: #d35400; /* Darker shade for hover */
}

/* Shepherd Tour Custom Styles */
.shepherd-text {
    direction: rtl !important;
    text-align: right !important;
    font-size: 16px !important;
    line-height: 1.5 !important;
    color: #333 !important;
}

.shepherd-footer {
    direction: rtl !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 1rem !important;
    background: #f8f9fa !important;
    border-top: 1px solid #e9ecef !important;
    border-radius: 0 0 8px 8px !important;
}

.shepherd-button {
    background-color: var(--primary-color) !important;
    border: none !important;
    border-radius: 6px !important;
    color: white !important;
    cursor: pointer !important;
    margin: 0 0.5rem !important;
    padding: 0.6rem 1.5rem !important;
    transition: all 0.3s ease !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.shepherd-button:not(:disabled):hover {
    background-color: var(--primary-hover) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15) !important;
}

.shepherd-button.shepherd-button-secondary {
    background-color: #6c757d !important;
}

.shepherd-button.shepherd-button-secondary:not(:disabled):hover {
    background-color: #5a6268 !important;
}

.shepherd-cancel-icon {
    background: transparent !important;
    border: none !important;
    color: white !important;
    font-size: 1.5em !important;
    cursor: pointer !important;
    font-weight: bold !important;
    margin: 0 !important;
    padding: 0.5rem !important;
    transition: all 0.3s ease !important;
    border-radius: 50% !important;
    width: 32px !important;
    height: 32px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.shepherd-cancel-icon:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: white !important;
}

.shepherd-has-title .shepherd-content .shepherd-header {
    background-color: var(--primary-color) !important;
    padding: 1.2rem !important;
    border-radius: 8px 8px 0 0 !important;
}

.shepherd-title {
    color: white !important;
    font-size: 1.2em !important;
    font-weight: bold !important;
    display: block !important;
    margin-bottom: 0.3rem !important;
}

.shepherd-content {
    border-radius: 8px !important;
    padding: 0 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    border: none !important;
    max-width: 400px !important;
    overflow: hidden !important;
}

.shepherd-text {
    padding: 1.2em !important;
    background: white !important;
}

.shepherd-footer {
    padding: 1rem !important;
    border-top: 1px solid #e9ecef !important;
    background: #f8f9fa !important;
    border-radius: 0 0 8px 8px !important;
}

/* Progress indicator */
.shepherd-progress {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    padding: 0.5rem 1rem !important;
    background: rgba(0,0,0,0.1) !important;
    color: white !important;
    font-size: 0.9em !important;
    border-radius: 0 8px 0 8px !important;
}

/* Close tour button */
.close-tour-button {
    position: fixed !important;
    bottom: 1rem !important;
    right: 1rem !important;
    background: rgba(255,255,255,0.9) !important;
    border: none !important;
    border-radius: 6px !important;
    padding: 0.5rem 1rem !important;
    color: #dc3545 !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    z-index: 10000 !important;
}

.close-tour-button:hover {
    background: white !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    transform: translateY(-1px) !important;
}

.reopen-tour-button {
    position: fixed !important;
    bottom: 1rem !important;
    right: 1rem !important;
    background: rgba(255,255,255,0.9) !important;
    border: none !important;
    border-radius: 50% !important;
    width: 40px !important;
    height: 40px !important;
    color: var(--primary-color) !important;
    font-size: 1.2em !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    z-index: 10000 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.reopen-tour-button:hover {
    background: white !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    transform: translateY(-1px) !important;
}

/* Shepherd tour theme customization */
.shepherd-theme-custom {
    --shepherd-theme-primary: #4CAF50;
    --shepherd-text-color: #333;
    --shepherd-bg: #fff;
    --shepherd-border-radius: 5px;
    --shepherd-box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.shepherd-theme-custom .shepherd-text {
    font-size: 16px;
    line-height: 1.5;
    padding: 20px;
}

.shepherd-theme-custom .shepherd-header {
    background-color: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 5px 5px 0 0;
}

.shepherd-theme-custom .shepherd-title {
    font-size: 18px;
    font-weight: bold;
}

.shepherd-theme-custom .shepherd-cancel-icon {
    color: white;
}

.shepherd-theme-custom .shepherd-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
}

.shepherd-theme-custom .shepherd-button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
}

.shepherd-theme-custom .shepherd-button:hover {
    background-color: #45a049;
}

.shepherd-theme-custom .shepherd-button:not(:last-child) {
    margin-left: 10px;
}

/* Fix for overlay issue */
.shepherd-modal-overlay-container {
    z-index: 9999 !important;
}

.shepherd-element {
    z-index: 10000 !important;
}

.shepherd-modal-overlay-container.shepherd-modal-is-visible {
    opacity: 0.5 !important;
}

.close-tour-button:hover {
    background: white !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    transform: translateY(-1px) !important;
}

/* Add this to your existing styles */
.tour-active .dropdown-content {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
}

.tour-active .dropdown-content a {
    pointer-events: auto !important;
}
</style>

<script>
// Main JavaScript for index.html
document.addEventListener("DOMContentLoaded", function() {
    // Add close tour button
    const closeButton = document.createElement('button');
    closeButton.className = 'close-tour-button';
    closeButton.innerHTML = 'לסגירת ההדרכה';
    closeButton.style.display = 'none';
    document.body.appendChild(closeButton);

    // Add reopen tour button
    const reopenButton = document.createElement('button');
    reopenButton.className = 'reopen-tour-button';
    reopenButton.innerHTML = '<i class="fas fa-question-circle"></i>';
    reopenButton.title = 'פתח הדרכה';
    reopenButton.style.display = 'none';
    document.body.appendChild(reopenButton);

    // Initialize Shepherd tour
    const tour = new Shepherd.Tour({
        defaultStepOptions: {
            classes: 'shepherd-theme-custom',
            scrollTo: true,
            cancelIcon: {
                enabled: true
            },
            useModalOverlay: true
        },
        useModalOverlay: true
    });

    // Add steps to the tour
    tour.addStep({
        id: 'welcome',
        text: 'ברוכים הבאים ל-Coupon Master! בואו נראה צעד אחרי צעד כיצד להשתמש באתר.',
        title: 'ברוכים הבאים!',
        buttons: [
            {
                text: 'הבא',
                action: tour.next
            }
        ]
    });

    tour.addStep({
        id: 'menu-button',
        text: '{{ "ראשית, כדי להוסיף קופון חדש לחצי על התפריט ואז על הוספת קופון" if current_user.gender == "female" else "ראשית, כדי להוסיף קופון חדש לחץ על התפריט ואז על הוספת קופון" }}',
        title: 'פתיחת התפריט',
        attachTo: {
            element: '.dropbtn',
            on: 'bottom'
        },
        buttons: [
            {
                text: 'הבא',
                action: tour.next
            },
            {
                text: 'דלג',
                action: tour.complete
            }
        ],
        when: {
            show: () => {
                // Ensure the menu button is clickable
                const menuButton = document.querySelector('.dropbtn');
                const dropdownContent = document.querySelector('.dropdown-content');
                if (menuButton && dropdownContent) {
                    menuButton.style.position = 'relative';
                    menuButton.style.zIndex = '10001';
                    // Add tour-active class to body
                    document.body.classList.add('tour-active');
                    // Show the dropdown content
                    dropdownContent.classList.add('show');
                    // Ensure the dropdown content is visible and interactive
                    dropdownContent.style.display = 'block';
                    dropdownContent.style.opacity = '1';
                    dropdownContent.style.visibility = 'visible';
                    dropdownContent.style.pointerEvents = 'auto';
                }
            },
            hide: () => {
                // Remove tour-active class from body
                document.body.classList.remove('tour-active');
                // Close the menu when leaving this step
                const dropdownContent = document.querySelector('.dropdown-content');
                if (dropdownContent) {
                    dropdownContent.classList.remove('show');
                    dropdownContent.style.display = '';
                    dropdownContent.style.opacity = '';
                    dropdownContent.style.visibility = '';
                    dropdownContent.style.pointerEvents = '';
                }
            }
        }
    });

    // Add new step for company cards row
    tour.addStep({
        id: 'company-cards',
        text: '{{ "כאן תוכלי לראות את כל הקופונים שלך מסודרים לפי חברות. לחצי על חברה מסוימץ כדי לראות את כל הקופונים שלה ולבחור במהירות את הקופון שברצונך להשתמש בו" if current_user.gender == "female" else "כאן תוכל לראות את כל הקופונים שלך מסודרים לפי חברות. לחץ על חברה מסוימת כדי לראות את כל הקופונים שלה ולבחור במהירות את הקופון שברצונך להשתמש בו" }}',
        title: 'גישה מהירה לקופונים',
        attachTo: {
            element: '#company-cards-row',
            on: 'bottom'
        },
        buttons: [
            {
                text: 'הבא',
                action: tour.next
            },
            {
                text: 'דלג',
                action: tour.complete
            }
        ],
        when: {
            show: () => {
                // Ensure the company cards row is visible
                const companyCardsRow = document.querySelector('#company-cards-row');
                if (companyCardsRow) {
                    companyCardsRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
    });

    // Add new step for coupon card explanation
    tour.addStep({
        id: 'coupon-card',
        text: '{{ "כאן תוכלי לראות את כל הקופונים הפעילים שלך (שאינם חד פעמיים). לכל קופון תוכלי לראות כמה נשאר לך לנצל, את קוד הקופון ואת אחוז השימוש. למשל, קופון לסופרמקרט על סך 100 שקל" if current_user.gender == "female" else "כאן תוכל לראות את כל הקופונים הפעילים שלך (שאינם חד פעמיים). לכל קופון תוכל לראות כמה נשאר לך לנצל, את קוד הקופון ואת אחוז השימוש. למשל, קופון לסופרמקרט על סך 100 שקל" }}',
        title: 'כרטיסי הקופונים',
        attachTo: {
            element: '.coupon-container-index',
            on: 'top'
        },
        buttons: [
            {
                text: 'הבא',
                action: tour.next
            },
            {
                text: 'דלג',
                action: tour.complete
            }
        ],
        when: {
            show: () => {
                // Ensure the coupon container is visible
                const couponContainer = document.querySelector('.coupon-container-index');
                if (couponContainer) {
                    couponContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
    });

    // Add new step for one-time coupons explanation
    tour.addStep({
        id: 'one-time-coupons',
        text: '{{ "כאן למטה תוכלי לראות את הקופונים החד פעמיים שברשותך. לכל קופון יש את קוד הקופון ואת המטרה שלו. למשל, קופון לקפה חינם ברולדין או שובר חד פעמי" if current_user.gender == "female" else "כאן למטה תוכל לראות את הקופונים החד פעמיים שברשותך. לכל קופון יש את קוד הקופון ואת המטרה שלו. למשל, קופון לקפה חינם ברולדין או שובר חד פעמי" }}',
        title: 'קופונים חד פעמיים',
        attachTo: {
            element: '.coupon-card-index-wrapper[data-is-one-time="true"]',
            on: 'top'
        },
        buttons: [
            {
                text: 'הבא',
                action: tour.next
            },
            {
                text: 'דלג',
                action: tour.complete
            }
        ],
        when: {
            show: (step) => {
                // Find the attached element (the first one-time coupon card)
                const attachedElement = document.querySelector('.coupon-card-index-wrapper[data-is-one-time="true"]');
                if (attachedElement) {
                    // Find the parent container for one-time coupons
                    const oneTimeHeading = Array.from(document.querySelectorAll(".coupon-section-title"))
                        .find(h => h.textContent.trim() === "קופונים חד פעמיים");
                    const oneTimeContainer = oneTimeHeading ? oneTimeHeading.nextElementSibling : null;

                    if (oneTimeContainer) {
                        // Scroll the container into view
                        oneTimeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Highlight the entire container
                        oneTimeContainer.style.position = 'relative'; // Ensure position is not static
                        oneTimeContainer.style.zIndex = '99999'; // Use a very high z-index
                        oneTimeContainer.style.boxShadow = '0 0 0 4px var(--primary-color)'; // Highlight border
                        oneTimeContainer.style.backgroundColor = 'rgba(52, 152, 219, 0.1)'; // Subtle background highlight

                        // Temporarily remove highlighting after a few seconds
                        setTimeout(() => {
                            oneTimeContainer.style.boxShadow = '';
                            oneTimeContainer.style.backgroundColor = '';
                        }, 2000);
                    }
                }
            },
            hide: () => {
                // Find the parent container for one-time coupons to reset styles
                 const oneTimeHeading = Array.from(document.querySelectorAll(".coupon-section-title"))
                    .find(h => h.textContent.trim() === "קופונים חד פעמיים");
                const oneTimeContainer = oneTimeHeading ? oneTimeHeading.nextElementSibling : null;

                if (oneTimeContainer) {
                    oneTimeContainer.style.position = ''; // Reset position
                    oneTimeContainer.style.zIndex = ''; // Reset z-index
                    oneTimeContainer.style.boxShadow = '';
                    oneTimeContainer.style.backgroundColor = '';
                }
            }
        }
    });

    // Handle tour completion
    tour.on('complete', () => {
        document.body.classList.remove('tour-active');
        closeButton.style.display = 'none';
        reopenButton.style.display = 'block';
        
        // Update tour progress in backend
        fetch('{{ url_for("profile.index") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: 'action=complete_tour&csrf_token={{ csrf_token() }}'
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to update tour progress');
            }
        })
        .catch(error => {
            console.error('Error updating tour progress:', error);
        });

        const menuButton = document.querySelector('.dropbtn');
        if (menuButton) {
            menuButton.style.zIndex = '';
        }
        // Close the menu when tour completes
        const dropdownContent = document.querySelector('.dropdown-content');
        if (dropdownContent) {
            dropdownContent.classList.remove('show');
            dropdownContent.style.display = '';
            dropdownContent.style.opacity = '';
            dropdownContent.style.visibility = '';
            dropdownContent.style.pointerEvents = '';
        }
    });

    tour.on('start', () => {
        closeButton.style.display = 'block';
        reopenButton.style.display = 'none';
        // Close the menu when tour starts
        const dropdownContent = document.querySelector('.dropdown-content');
        if (dropdownContent) {
            dropdownContent.classList.remove('show');
            dropdownContent.style.display = '';
            dropdownContent.style.opacity = '';
            dropdownContent.style.visibility = '';
            dropdownContent.style.pointerEvents = '';
        }
    });

    // Handle close button click
    closeButton.addEventListener('click', () => {
        tour.complete();
        closeButton.style.display = 'none';
        reopenButton.style.display = 'block';
        const menuButton = document.querySelector('.dropbtn');
        if (menuButton) {
            menuButton.style.zIndex = '';
        }
    });

    // Handle reopen button click
    reopenButton.addEventListener('click', () => {
        tour.start();
    });

    // Check if we need to show the tour based on backend flag
    {% if show_tour %}
        // First visit - show tour automatically
        tour.start();
        closeButton.style.display = 'block';
        reopenButton.style.display = 'none';
    {% else %}
        // Not first visit - show only reopen button
        reopenButton.style.display = 'block';
        closeButton.style.display = 'none';
    {% endif %}

    // Add event listener for tour state changes
    tour.on('show', () => {
        closeButton.style.display = 'block';
        reopenButton.style.display = 'none';
    });

    tour.on('hide', () => {
        closeButton.style.display = 'none';
        reopenButton.style.display = 'block';
    });

    // Load the coupon modals
    loadCouponModals();
    
    // # Variable to track if usage has been updated
    let usageUpdated = false;
    
    // # Shift key tracking
    let isShiftKeyPressed = false;
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Shift') {
        isShiftKeyPressed = true;
      }
    });
    
    document.addEventListener('keyup', function(e) {
      if (e.key === 'Shift') {
        isShiftKeyPressed = false;
      }
    });

    // # 1) Collect active coupons based on "קופונים פעילים" section
    const activeHeading = Array.from(document.querySelectorAll(".coupon-section-title"))
      .find(h => h.textContent.trim() === "קופונים פעילים");
    const activeContainer = activeHeading ? activeHeading.nextElementSibling : null;
    const activeCoupons = activeContainer ? activeContainer.querySelectorAll(".coupon-card-index-wrapper") : [];

    // # 1.1) Collect one-time coupons
    const oneTimeHeading = Array.from(document.querySelectorAll(".coupon-section-title"))
      .find(h => h.textContent.trim() === "קופונים חד פעמיים");
    const oneTimeContainer = oneTimeHeading ? oneTimeHeading.nextElementSibling : null;
    const oneTimeCoupons = oneTimeContainer ? oneTimeContainer.querySelectorAll(".coupon-card-index-wrapper") : [];

    // # 2) Group coupons by company
    const companyMap = {};
    activeCoupons.forEach(card => {
      const company = card.getAttribute("data-company") || "אחר";
      if (!companyMap[company]) {
        companyMap[company] = [];
      }
      companyMap[company].push(card);
    });

    // # 2.1) Add one-time coupons to the group
    oneTimeCoupons.forEach(card => {
      const company = card.getAttribute("data-company") || "אחר";
      if (!companyMap[company]) {
        companyMap[company] = [];
      }
      companyMap[company].push(card);
    });

    // # 3) Create company cards in the filter row
    const companyCardsRow = document.getElementById("company-cards-row");
    Object.keys(companyMap).forEach(company => {
      const cards = companyMap[company];
      const firstCard = cards[0];
      const logoSrc = firstCard.getAttribute("data-logo-src") || "";
      const count = cards.length;

      const cardBox = document.createElement("div");
      cardBox.classList.add("company-card-box");
      cardBox.setAttribute("data-company", company);

      const imgEl = document.createElement("img");
      imgEl.src = logoSrc;
      imgEl.alt = company;
      cardBox.appendChild(imgEl);

      const titleEl = document.createElement("h3");
      titleEl.textContent = company;
      cardBox.appendChild(titleEl);

      const pEl = document.createElement("p");
      pEl.textContent = count + " קופונים פעילים";
      cardBox.appendChild(pEl);

      cardBox.addEventListener("click", function() {
        openCompanyModal(company, cards);
      });

      companyCardsRow.appendChild(cardBox);
    });

    // # Function to load coupon modals
    function loadCouponModals() {
      fetch('{{ url_for("coupons.load_coupon_modals") }}')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load coupon modals');
          }
          return response.text();
        })
        .then(html => {
          // # Insert the modal HTML
          document.getElementById('couponModalsContainer').innerHTML = html;
          
          // # Execute scripts from the loaded content
          const scriptTags = document.getElementById('couponModalsContainer').getElementsByTagName('script');
          for (let i = 0; i < scriptTags.length; i++) {
            const newScript = document.createElement('script');
            Array.from(scriptTags[i].attributes).forEach(attr => {
              newScript.setAttribute(attr.name, attr.value);
            });
            newScript.appendChild(document.createTextNode(scriptTags[i].innerHTML));
            document.head.appendChild(newScript);
          }
        })
        .catch(error => {
          console.error('Error loading coupon modals:', error);
        });
    }

    // # Function to open company modal (will be handled by the loaded modal script)
    function openCompanyModal(company, cardList) {
      // # This function will be replaced by the one loaded from coupon_modals.html
      if (window.openCompanyModal) {
        window.openCompanyModal(company, cardList);
      } else {
        console.error('Modal functions not loaded yet');
      }
    }

    // # 7) Close admin message
    document.querySelectorAll(".close-button").forEach(button => {
      button.addEventListener("click", function (event) {
          event.preventDefault();
          let form = this.closest("form");
          let url = form.action;
          let csrfToken = form.querySelector("input[name='csrf_token']").value;
          fetch(url, {
              method: "POST",
              headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `csrf_token=${csrfToken}`
          }).then(response => {
              if (response.ok) {
                  form.closest(".admin-flash-message").remove();
              } else {
                  alert("שגיאה בעת סגירת ההודעה");
              }
          });
      });
    });

    // # 8) Load statistics modal dynamically
    const openStatsModalBtn = document.getElementById("open-stats-modal");
    const statsModal = document.getElementById("statsModal");
    
    if (openStatsModalBtn) {
      openStatsModalBtn.addEventListener("click", function() {
        loadStatsModal();
      });
    }
    
    // # Function to load stats modal content dynamically
    function loadStatsModal() {
      fetch('{{ url_for("profile.load_stats_modal") }}')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load stats modal');
          }
          return response.text();
        })
        .then(html => {
          // # Insert the modal HTML
          statsModal.innerHTML = html;
          
          // # Important - manually extract and execute scripts
          const scriptTags = statsModal.getElementsByTagName('script');
          for (let i = 0; i < scriptTags.length; i++) {
            const newScript = document.createElement('script');
            Array.from(scriptTags[i].attributes).forEach(attr => {
              newScript.setAttribute(attr.name, attr.value);
            });
            newScript.appendChild(document.createTextNode(scriptTags[i].innerHTML));
            document.head.appendChild(newScript);
          }
          
          // # Show the modal
          statsModal.classList.add("active");
          
          // # Add event listeners for modal close
          const closeStatsModal = document.querySelector(".close-stats-modal");
          if (closeStatsModal) {
            closeStatsModal.addEventListener("click", function() {
              statsModal.classList.remove("active");
            });
          }
          
          window.addEventListener("click", function(e) {
            if (e.target === statsModal) {
              statsModal.classList.remove("active");
            }
          });
          
          // # Short delay to ensure scripts are loaded
          setTimeout(() => {
            // # Get the stats data from the hidden div
            const statsData = document.getElementById('stats-data');
            const companiesStats = JSON.parse(statsData.getAttribute('data-companies-stats'));
            const timelineData = JSON.parse(statsData.getAttribute('data-timeline-data'));
            const totalSavings = parseFloat(statsData.getAttribute('data-total-savings'));
            const totalCouponsValue = parseFloat(statsData.getAttribute('data-total-coupons-value'));
            const percentageSavings = parseFloat(statsData.getAttribute('data-percentage-savings'));
            const totalCouponsCount = parseInt(statsData.getAttribute('data-total-coupons-count'));
            const activeCouponsCount = parseInt(statsData.getAttribute('data-active-coupons-count') || '0');
            const averageUsagePercentage = parseFloat(statsData.getAttribute('data-average-usage-percentage'));
            
            // # Check if function is available after script execution
            if (typeof window.renderSavingsCharts === 'function') {
              window.renderSavingsCharts({
                companiesStats,
                timelineData,
                totalSavings,
                totalCouponsValue,
                percentageSavings,
                totalCouponsCount,
                activeCouponsCount,
                averageUsagePercentage
              });
            } else {
              console.error('Error: renderSavingsCharts function not found after script execution');
              alert('שגיאה באתחול נתוני הסטטיסטיקות. אנא רענן את הדף ונסה שוב.');
            }
          }, 50);  // # Short delay to ensure scripts are loaded
        })
        .catch(error => {
          console.error('Error loading stats modal:', error);
          alert('שגיאה בטעינת חלון הסטטיסטיקות. אנא נסה שוב מאוחר יותר.');
        });
    }
    
    // # Quick Add Coupon Modal functionality
    const quickAddCouponBtn = document.getElementById("quick-add-coupon-btn");
    const quickAddCouponModal = document.getElementById("quickAddCouponModal");

    if (quickAddCouponBtn) {
      quickAddCouponBtn.addEventListener("click", function() {
        loadQuickAddCouponModal();
      });
    }

    // # Function to load quick add coupon modal
    function loadQuickAddCouponModal() {
        // # First, clear any previous content and add active class
        quickAddCouponModal.innerHTML = '';
        quickAddCouponModal.className = 'modal active';
        
        // # Set up container styles directly - dark semi-transparent background
        quickAddCouponModal.style.position = 'fixed';
        quickAddCouponModal.style.zIndex = '9999';
        quickAddCouponModal.style.left = '0';
        quickAddCouponModal.style.top = '0';
        quickAddCouponModal.style.width = '100%';
        quickAddCouponModal.style.height = '100%';
        quickAddCouponModal.style.backgroundColor = 'rgba(0,0,0,0.7)'; // # Semi-transparent dark background
        quickAddCouponModal.style.display = 'flex';
        quickAddCouponModal.style.justifyContent = 'center';
        quickAddCouponModal.style.alignItems = 'center';
        
        // # Fetch the modal content from the server
        fetch('{{ url_for("coupons.load_quick_add_coupon_modal") }}')
            .then(response => response.text())
            .then(html => {
                // # Create an iframe with height that fills most of the screen
                const iframe = document.createElement('iframe');
                iframe.style.width = '90%'; // # 90% of screen width
                iframe.style.maxWidth = '550px'; // # Maximum width
                iframe.style.height = '90vh'; // # 90% of viewport height
                iframe.style.maxHeight = '90vh'; // # Maximum 90% of viewport height
                iframe.style.border = 'none';
                iframe.style.borderRadius = '15px';
                iframe.style.backgroundColor = 'white'; // # White background for modal
                iframe.style.boxShadow = '0 5px 15px rgba(0,0,0,0.5)'; // # Strong shadow
                
                // # Check if device is mobile
                const isMobile = window.innerWidth <= 768;
                
                // # Adjust height for mobile - almost full screen
                if (isMobile) {
                    iframe.style.height = '85vh';
                    iframe.style.maxHeight = '85vh';
                }
                
                // # Add to modal container
                quickAddCouponModal.appendChild(iframe);
                
                // # Add backdrop click to close
                quickAddCouponModal.addEventListener('click', function(e) {
                    if (e.target === quickAddCouponModal) {
                        quickAddCouponModal.classList.remove('active');
                    }
                });
                
                // # Write the HTML content to the iframe
                setTimeout(() => {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(html);
                    iframeDoc.close();
                    
                    // # After iframe content is loaded, adjust internal styling
                    iframe.onload = function() {
                        try {
                            const style = iframe.contentDocument.createElement('style');
                            style.textContent = `
                                body, html {
                                    background-color: white !important;
                                    margin: 0 !important;
                                    padding: 0 !important;
                                    height: 100% !important;
                                }
                                
                                #quickAddModal {
                                    height: 100% !important;
                                    max-height: 100% !important;
                                }
                                
                                .modal-content {
                                    border-radius: 15px !important;
                                    height: 100% !important;
                                }
                            `;
                            iframe.contentDocument.head.appendChild(style);
                            
                            // # Process iframe content elements
                            const modalElement = iframe.contentDocument.querySelector('#quickAddModal');
                            
                            // # Make sure the modal is active within the iframe
                            if (modalElement) {
                                modalElement.classList.add('active');
                                
                                // # Override the close function inside the iframe
                                const innerCloseBtn = modalElement.querySelector('.close-modal');
                                if (innerCloseBtn) {
                                    innerCloseBtn.addEventListener('click', function() {
                                        quickAddCouponModal.classList.remove('active');
                                    });
                                }
                            }
                        } catch (error) {
                            console.error('Error adjusting iframe content:', error);
                        }
                    };
                }, 100);
            })
            .catch(error => {
                console.error('Error loading modal:', error);
                quickAddCouponModal.innerHTML = '<div style="background:white; padding:20px; border-radius:10px; text-align:center;">שגיאה בטעינת המודל. אנא נסה שוב.</div>';
            });
    }

    // # Function to show flash messages programmatically
    function showFlashMessage(message, type = 'success') {
      const flashContainer = document.createElement('div');
      flashContainer.className = `flash-message ${type}`;
      flashContainer.innerHTML = `
          <span>${message}</span>
          <button class="close-flash">&times;</button>
      `;
      document.body.appendChild(flashContainer);
      
      // # Add animation class after a short delay
      setTimeout(() => {
          flashContainer.classList.add('show');
      }, 10);
      
      // # Remove the message after 5 seconds
      setTimeout(() => {
          flashContainer.classList.remove('show');
          setTimeout(() => {
          flashContainer.remove();
          }, 300);
      }, 5000);
      
      // # Add click handler to close button
      const closeButton = flashContainer.querySelector('.close-flash');
      closeButton.addEventListener('click', () => {
          flashContainer.classList.remove('show');
          setTimeout(() => {
          flashContainer.remove();
          }, 300);
      });
    }

    // # Listen for custom events from the iframe
    document.addEventListener('showFlashMessage', function(e) {
      showFlashMessage(e.detail.message, e.detail.type);
    });
    
    // # Load usage report modal handler function
    const openUsageModalBtn = document.getElementById("openUsageModalBtn");
    if (openUsageModalBtn) {
      openUsageModalBtn.addEventListener("click", function() {
        loadUsageReportModal();
      });
    }
    
    // # Function to handle usage report modal  
    function loadUsageReportModal() {
      fetch('{{ url_for("coupons.load_usage_report_modal") }}')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load usage report modal');
          }
          return response.text();
        })
        .then(html => {
          // # Insert the modal HTML
          const usageModalContainer = document.getElementById("usageModalContainer");
          if (usageModalContainer) {
            usageModalContainer.innerHTML = html;
            
            // # Execute scripts from the loaded content
            const scriptTags = usageModalContainer.getElementsByTagName('script');
            for (let i = 0; i < scriptTags.length; i++) {
              const newScript = document.createElement('script');
              Array.from(scriptTags[i].attributes).forEach(attr => {
                newScript.setAttribute(attr.name, attr.value);
              });
              newScript.appendChild(document.createTextNode(scriptTags[i].innerHTML));
              document.head.appendChild(newScript);
            }
            
            // # Show the modal
            const usageReportModal = document.getElementById("usageReportModal");
            if (usageReportModal) {
              usageReportModal.classList.add("active");
              
              // # Add event handlers for closing the modal
              const closeModal = function() {
                usageReportModal.classList.remove("active");
              };
              
              // # Ensure the close button has a listener
              const closeBtn = usageReportModal.querySelector(".close-modal");
              if (closeBtn) {
                closeBtn.addEventListener("click", closeModal);
              }
              
              // # Add event listener for backdrop clicks
              usageReportModal.addEventListener("click", function(e) {
                if (e.target === usageReportModal) {
                  closeModal();
                }
              });
              
              // # Add event handlers for the usage report form
              setupUsageReportFormHandlers();
            }
          }
        })
        .catch(error => {
          console.error('Error loading usage report modal:', error);
          showFlashMessage('שגיאה בטעינת טופס הדיווח. אנא נסה שוב.', 'error');
        });
    }
    
    // # Setup handlers for the usage report form
    function setupUsageReportFormHandlers() {
      const usageReportForm = document.getElementById("usageReportForm");
      if (!usageReportForm) return;
      
      usageReportForm.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // # Show loading state
        const submitBtn = this.querySelector('.submit-button');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'מעבד...';
        submitBtn.disabled = true;
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
          
          if (data.success) {
            // # Special handling for review modal URL
            if (data.modal_url) {
              fetch(data.modal_url)
                .then(response => response.text())
                .then(html => {
                  // # Replace modal content with review form
                  const modalContent = document.querySelector("#usageReportModal .modal-content");
                  if (modalContent) {
                    modalContent.innerHTML = html;
                    
                    // # Initialize handlers for the review form
                    setupReviewFormHandlers();
                  }
                })
                .catch(error => {
                  console.error('Error loading review modal:', error);
                  showFlashMessage('שגיאה בטעינת מסך הסקירה', 'error');
                });
            } else if (data.redirect) {
              window.location.href = data.redirect;
            } else {
              // # Close modal and show success message
              const modal = document.getElementById("usageReportModal");
              if (modal) modal.classList.remove("active");
              
              showFlashMessage(data.message || 'הדיווח נשלח בהצלחה', 'success');
              this.reset();
            }
          } else {
            showFlashMessage(data.message || 'אירעה שגיאה בשליחת הדיווח', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
          
          showFlashMessage('אירעה שגיאה בשליחת הדיווח', 'error');
        });
      });
    }
    
    // # Setup handlers for the review form
    function setupReviewFormHandlers() {
      const reviewForm = document.getElementById("reviewUsageForm");
      if (!reviewForm) return;
      
      // # Handle "Use All" button clicks
      document.querySelectorAll(".btn-used").forEach(function(button) {
        button.addEventListener("click", function() {
          const row = this.closest("tr");
          const selectElem = row.querySelector(".coupon-select");
          const selectedOption = selectElem.options[selectElem.selectedIndex];
          const remainingAmount = parseFloat(selectedOption.getAttribute("data-remaining")).toFixed(2);
          const amountInput = row.querySelector(".amount-input");

          if (remainingAmount !== null) {
            amountInput.value = remainingAmount;
          }
        });
      });
      
      // # Handle form submission
      reviewForm.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          // # Close the modal
          const modal = document.getElementById("usageReportModal");
          if (modal) modal.classList.remove("active");
          
          // # Show success/error messages
          if (data.success) {
            showFlashMessage(data.message, 'success');
            
            // # Display individual success messages with delay
            if (data.successes && data.successes.length > 0) {
              data.successes.forEach((msg, index) => {
                setTimeout(() => {
                  showFlashMessage(msg, 'success');
                }, 500 + (index * 300));
              });
            }
          } else {
            showFlashMessage(data.message || 'אירעה שגיאה בעדכון השימושים', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showFlashMessage('אירעה שגיאה בעת שליחת הטופס', 'error');
        });
      });
      
      // # Handle cancel button
      const cancelBtn = reviewForm.querySelector(".cancel-button");
      if (cancelBtn) {
        cancelBtn.addEventListener("click", function() {
          const modal = document.getElementById("usageReportModal");
          if (modal) modal.classList.remove("active");
        });
      }
      
      // # Handle close button
      const closeBtn = document.querySelector(".close-modal");
      if (closeBtn) {
        closeBtn.addEventListener("click", function() {
          const modal = document.getElementById("usageReportModal");
          if (modal) modal.classList.remove("active");
        });
      }
    }
    
    // # Check if we need to show the review modal based on URL parameter
    {% if show_review_modal %}
    // # Automatically load the review modal on page load if URL parameter is present
    fetch('{{ url_for("coupons.load_review_modal") }}')
      .then(response => response.text())
      .then(html => {
        // # Replace modal content
        const usageReportModal = document.getElementById("usageReportModal");
        if (usageReportModal) {
          const modalContent = usageReportModal.querySelector(".modal-content");
          modalContent.innerHTML = html;
            
          // # Show the modal
          usageReportModal.classList.add("active");
            
          // # Initialize handlers for the review form
          setupReviewFormHandlers();
            
          // # Clean up URL parameter (optional)
          const url = new URL(window.location.href);
          url.searchParams.delete('show_review_modal');
          window.history.replaceState({}, '', url);
        }
      })
      .catch(error => {
        console.error('Error loading review modal:', error);
        if (typeof showFlashMessage === 'function') {
          showFlashMessage('שגיאה בטעינת מסך הסקירה', 'error');
        }
      });
    {% endif %}
});
</script>
<script src="{{ url_for('static', filename='js/tooltip.js') }}" defer></script>
{% endblock %}