{% extends 'base.html' %}

{% block title %}
×”×•×¡×¤×ª ×§×•×¤×•×Ÿ
{% endblock %}

{% block content %}
<section class="add-coupon">
    <h2>×”×•×¡×¤×ª ×§×•×¤×•×Ÿ ×—×“×©</h2>
    <!-- Existing buttons above the form -->
    <div class="add-coupons-buttons">
        <div class="button-row">
            <a href="{{ url_for('coupons.add_coupons_bulk') }}" class="secondary-button">
                <i class="fa fa-plus-circle" aria-hidden="true"></i> ×”×•×¡×¤×ª ×§×•×¤×•× ×™× ××¨×•×‘×™×
            </a>
            <a href="{{ url_for('coupons.upload_coupons') }}" class="secondary-button">
                <i class="fa fa-upload" aria-hidden="true"></i> ×”×¢×œ××ª ×§×•×‘×¥ ×§×•×¤×•× ×™×
            </a>
        </div>
        <div class="button-row full-width">
            <a href="{{ url_for('coupons.add_coupon_with_image') }}" class="secondary-button wide-button">
                <i class="fa fa-image" aria-hidden="true"></i> ×”×•×¡×¤×ª ×§×•×¤×•×Ÿ ××ª××•× ×”
            </a>
        </div>
    </div>

    <!-- Display flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if not show_coupon_form %}
        {% if current_user.slots_automatic_coupons > 0 %}
        <!-- Automatic SMS input form -->
        <form method="post">
            {{ sms_form.hidden_tag() }}
            <!-- SMS Text Field -->
            <div class="form-group center-text">
                {{ sms_form.sms_text.label(class="form-label") }}
                {{ sms_form.sms_text(class="input-field", placeholder="×›××Ÿ ××›× ×™×¡×™× ××ª ×ª×•×›×Ÿ ×”×”×•×“×¢×”") }}
                {% for error in sms_form.sms_text.errors %}
                    <div class="error">{{ error }}</div>
                {% endfor %}
            </div>
            <div class="form-group" style="position: relative;">
                <!-- Mobile supporting text -->
                <div class="slots-info-mobile center-text">
                    ×™×© ×œ×š ×¢×•×“ {{ current_user.slots_automatic_coupons }} ×¡×œ×•×˜×™× ×–××™× ×™× ×œ××™×œ×•×™ ××•×˜×•××˜×™.
                </div>
                
                <!-- Wrapper for "Next" button and tooltip -->
                <div class="mobile-buttons-container">
                    {{ sms_form.submit_sms(class="submit-button") }}
                    <div class="tooltip-container">
                        <button type="button" class="tooltip-button-mobile" aria-label="××™×“×¢ × ×•×¡×£">â”</button>
                        <div class="mobile-tooltip">
                            ×™×© ×œ×š ×¢×•×“ {{ current_user.slots_automatic_coupons }} ×¡×œ×•×˜×™× ×–××™× ×™× ×œ××™×œ×•×™ ××•×˜×•××˜×™.
                            <span class="close-tooltip">Ã—</span>
                        </div>
                    </div>
                </div>                
                            
                <!-- Desktop tooltip (appears on hover) -->
                <div class="tooltip">
                    ×™×© ×œ×š ×¢×•×“ {{ current_user.slots_automatic_coupons }} ×¡×œ×•×˜×™× ×–××™× ×™× ×œ××™×œ×•×™ ××•×˜×•××˜×™.
                </div>
            </div>
        </form>
        {% else %}
        <div class="no-slots-message center-text">
            <p>××™×Ÿ ×œ×š ××¡×¤×™×§ ×¡×œ×•×˜×™× ×œ×”×–× ×ª ×§×•×¤×•× ×™× ××•×˜×•××˜×™×ª. ×× × ×¨×›×© ×¡×œ×•×˜×™× × ×•×¡×¤×™× ××• ×”×–×Ÿ ×§×•×¤×•×Ÿ ×™×“× ×™×ª.</p>
        </div>
        {% endif %}
        <!-- Manual entry option -->
        <div class="manual-entry center-text">
            <p>××• ×©×ª×–×™×Ÿ ×‘××•×¤×Ÿ ×™×“× ×™ ××ª ×”×¤×¨×˜×™× ×©×œ ×”×§×•×¤×•×Ÿ</p>
            <a href="{{ url_for('coupons.add_coupon', manual='true') }}" class="secondary-button">
                <i class="fa fa-edit" aria-hidden="true"></i> ×”×–× ×ª ×¤×¨×˜×™× ×‘××•×¤×Ÿ ×™×“× ×™
            </a>
        </div>
    {% else %}
    <!-- Manual coupon entry form -->
    <form method="post" enctype="multipart/form-data">
        {{ coupon_form.hidden_tag() }}

        <!-- Image Upload Field -->
        <!--
        <div class="form-group">
            <label for="coupon_image">×”×¢×œ×” ×ª××•× ×” ×©×œ ×”×§×•×¤×•×Ÿ</label>
            <input type="file" name="coupon_image" id="coupon_image" accept="image/*" class="input-field">
            {% for error in coupon_form.coupon_image.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>
        -->

        <!-- Company Name -->
        <div class="form-group">
            {{ coupon_form.company_id.label(class="form-label") }}
            {{ coupon_form.company_id(class="input-field", id="company_select", required=True) }}
            {% for error in coupon_form.company_id.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>
        <div class="form-group" id="other_company_group" style="display: none;">
            {{ coupon_form.other_company.label(class="form-label") }}
            {{ coupon_form.other_company(class="input-field", id="other_company") }}
            {% for error in coupon_form.other_company.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- BuyMe Coupon Link Field -->
        <div class="form-group" id="buyme_coupon_link_group" style="display: none;">
            <label for="buyme_coupon_link">×›×ª×•×‘×ª URL ×©×œ ×”×§×•×¤×•×Ÿ ×œ-BuyMe</label>
            {{ coupon_form.buyme_coupon_url(class="input-field", id="buyme_coupon_link") }}
        </div>

<!--
        Tags Field
        <div class="form-group">
            {{ coupon_form.tag_id.label(class="form-label") }}
            {{ coupon_form.tag_id(class="input-field", id="tag_select", required=True) }}
            {% for error in coupon_form.tag_id.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>
        <div class="form-group" id="other_tag_group" style="display: none;">
            {{ coupon_form.other_tag.label(class="form-label") }}
            {{ coupon_form.other_tag(class="input-field", id="other_tag") }}
            {% for error in coupon_form.other_tag.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>
-->

        <!-- Code Field -->
        <div class="form-group">
            {{ coupon_form.code.label(class="form-label") }}
            {{ coupon_form.code(class="input-field", id="code", required=True) }}
            {% for error in coupon_form.code.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Coupon Cost Field -->
        <div class="form-group">
            {{ coupon_form.cost.label(class="form-label") }}
            {{ coupon_form.cost(class="input-field", id="coupon_cost", required=True, type="number", inputmode="numeric", pattern="[0-9]*", step="0.01") }}
            {% for error in coupon_form.cost.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Discount Percentage Field -->
        <div class="form-group">
            {{ coupon_form.discount_percentage.label(class="form-label") }}
            {{ coupon_form.discount_percentage(class="input-field", id="discount_percentage_input", type="number", inputmode="numeric", pattern="[0-9]*", min="0", max="100", step="0.01") }}
            {% for error in coupon_form.discount_percentage.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Desired Value Field -->
        <div class="form-group">
            {{ coupon_form.value.label(class="form-label") }}
            {{ coupon_form.value(class="input-field", id="desired_value", required=True, type="number", inputmode="numeric", pattern="[0-9]*", step="0.01") }}
            {% for error in coupon_form.value.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Expiration Field -->
        <div class="form-group">
            {{ coupon_form.expiration.label(class="form-label") }}
            {{ coupon_form.expiration(class="input-field", id="expiration") }}
            {% for error in coupon_form.expiration.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Description Field -->
        <div class="form-group">
            {{ coupon_form.description.label(class="form-label") }}
            {{ coupon_form.description(class="input-field", id="description") }}
            {% for error in coupon_form.description.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Source Field -->
        <div class="form-group">
            {{ coupon_form.source.label(class="form-label") }}
            {{ coupon_form.source(class="input-field", id="source") }}
            {% for error in coupon_form.source.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Checkbox: ×”×× ×œ×”×›× ×™×¡ ×ª×•×§×£ ×›×¨×˜×™×¡ ×•-CVV -->
        <div class="form-group checkbox-inline">
            <label for="include_card_info">
                <input type="checkbox" id="include_card_info" name="include_card_info">
                ×”×× ×œ×”×›× ×™×¡ ×ª×•×§×£ ×›×¨×˜×™×¡ ×•-CVV?
            </label>
        </div>

        <!-- Card fields, hidden by default -->
        <div id="card_fields_container" style="display: none;">
            <!-- CVV Field -->
            <div class="form-group">
                {{ coupon_form.cvv.label(class="form-label") }}
                {{ coupon_form.cvv(class="input-field", id="cvv") }}
                {% for error in coupon_form.cvv.errors %}
                    <div class="error">{{ error }}</div>
                {% endfor %}
            </div>

            <!-- Card Exp Field -->
            <div class="form-group">
                <label for="card_exp">×ª×•×§×£ ×›×¨×˜×™×¡</label>
                <input type="text" id="card_exp" name="card_exp" class="input-field" maxlength="5" placeholder="MM/YY"
                    value="{{ coupon_form.card_exp.data if coupon_form.card_exp.data else '' }}">
                {% for error in coupon_form.card_exp.errors %}
                    <div class="error">{{ error }}</div>
                {% endfor %}
            </div>
        </div>

        <!-- One-Time Use Checkbox (with tooltip) -->
        <div class="form-group tooltip-checkbox-container" style="position: relative;">
            <button type="button" class="tooltip-button-mobile" id="tooltipOneTimeButtonMobile" aria-label="××™×“×¢ × ×•×¡×£">â”</button>
            {{ coupon_form.is_one_time() }}
            <label for="is_one_time" class="form-label">
                {{ coupon_form.is_one_time.label }}
            </label>
            <div class="mobile-tooltip" id="TooltipOneTimeUse">
                ×§×•×¤×•×Ÿ ×—×“-×¤×¢××™ - ×××¤×©×¨ ×©×™××•×© ××—×“ ×‘×œ×‘×“, ×‘× ×™×’×•×“ ×œ×§×•×¤×•× ×™× ×¨×‘-×¤×¢××™×™× ×‘×”× ×”×™×ª×¨×” × ×©××¨×ª ×œ×©×™××•×©×™× ×”×‘××™×.
                <span class="close-tooltip" id="closeTooltipOneTime">Ã—</span>
            </div>
            <div class="tooltip" id="TooltipOneTimeUse">
                ×§×•×¤×•×Ÿ ×—×“-×¤×¢××™ - ×××¤×©×¨ ×©×™××•×© ××—×“ ×‘×œ×‘×“, ×‘× ×™×’×•×“ ×œ×§×•×¤×•× ×™× ×¨×‘-×¤×¢××™×™× ×‘×”× ×”×™×ª×¨×” × ×©××¨×ª ×œ×©×™××•×©×™× ×”×‘××™×.
                <span class="close-tooltip" id="closeTooltipOneTime">Ã—</span>
            </div>
        </div>

            {% for error in coupon_form.is_one_time.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Purpose Field (Hidden by default) -->
        <div class="form-group" id="purpose_group" style="display: none;">
            {{ coupon_form.purpose.label(class="form-label") }}
            {{ coupon_form.purpose(class="input-field", id="purpose") }}
            {% for error in coupon_form.purpose.errors %}
                <div class="error">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Submit Button -->
        <div class="form-group">
            {{ coupon_form.submit_coupon(class="submit-button", id="submit_coupon_button", disabled=true) }}
            <div id="validation_message" class="error" style="display:none; margin-top: 5px;">
                ×™×© ×œ××œ× ×œ×¤×—×•×ª ×©× ×™×™× ××”×©×“×•×ª: ××—×™×¨ ×§×•×¤×•×Ÿ, ×¢×¨×š ×§×•×¤×•×Ÿ, ××—×•×– ×”× ×—×”, ×‘×¢×¨×š ×’×“×•×œ ×-0.
            </div>
        </div>
    </form>
    <!-- Back to automatic entry button -->
    <div class="manual-entry center-text">
        <p>×—×–×¨×” ×œ××¡×š ×”×–× ×ª ×§×•×¤×•×Ÿ ×‘××•×¤×Ÿ ××•×˜×•××˜×™×ª:</p>
        <a href="{{ url_for('coupons.add_coupon') }}" class="secondary-button">
            <i class="fa fa-arrow-left" aria-hidden="true"></i> ×—×–×•×¨ ×œ×”×–× ×ª ×§×•×¤×•×Ÿ ××•×˜×•××˜×™×ª
        </a>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tooltip.css') }}">
<script src="{{ url_for('static', filename='js/tooltip.js') }}" defer></script>

<style>
    .center-text {
        text-align: center;
    }
    
    .slots-info-mobile {
        display: none;
        font-size: 12px;
        color: #333;
        margin-bottom: 5px;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
        .slots-info-mobile {
            display: block;
        }
        .no-slots-message {
            text-align: center;
        }
        .manual-entry p {
            text-align: center;
        }
    
        /* Create a grid with 2 columns for top buttons */
        .add-coupons-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equally sized columns */
            gap: 10px; /* Space between buttons */
            align-items: center;
            justify-content: center;
            width: 100%;
        }
    
        /* Adjust button styling */
        .button-row {
            display: contents; /* Preserve grid layout */
        }
    
        .button-row a {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            font-size: 16px;
            text-align: center;
            min-height: 50px; /* Uniform height */
            width: 100%;
        }
    
        /* Wide button doesn't span the entire width */
        .button-row.full-width {
            grid-column: span 2; /* Takes up the entire width of the grid */
            display: flex;
            justify-content: center;
            width: 100%;
        }
    
        .wide-button {
            width: 100%; /* Now its width matches the buttons above */
            max-width: 100%;
        }
        .tooltip {
            /* Allows seeing the text but not capturing clicks/touch */
            pointer-events: none;
        }

        .tooltip .close-tooltip {
            /* Only allow clicks on the close button */
            pointer-events: auto; 
        }

    }
    
    /* Desktop styles (unchanged) */
    @media (min-width: 769px) {
        .add-coupons-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
    
        .button-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 5px;
        }
    
        .button-row.full-width {
            width: 100%;
        }
    
        .wide-button {
            flex-grow: 1;
            text-align: center;
            display: block;
            width: 100%;
            max-width: 320px;
        }
    }
</style>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    let index = {{ form.coupons|length }};
    
    // === Helper function to parse float values safely ===
    function toFloat(value) {
        const num = parseFloat(value);
        return isNaN(num) ? null : num;
    }

    // === Auto-calculation functionality for discount, cost and value ===
    function setupCalculations(fieldset) {
        const idx = fieldset.dataset.index;
        const valueInput = fieldset.querySelector(`#coupons-${idx}-value`);
        const costInput = fieldset.querySelector(`#coupons-${idx}-cost`);
        const discountInput = fieldset.querySelector(`#coupons-${idx}-discount_percentage`);
        const validationMessage = fieldset.querySelector('.validation-message');
        
        if (!valueInput || !costInput || !discountInput) return;
        
        function updateFields(changedField) {
            const value = toFloat(valueInput.value);
            const cost = toFloat(costInput.value);
            const discount = toFloat(discountInput.value);
            
            // Special case: If cost is exactly 0 and value is positive, set discount to 100%
            if (cost === 0 && value > 0) {
                discountInput.value = "100.00";
                if (validationMessage) validationMessage.style.display = 'none';
                return;
            }
            
            let filledCount = 0;
            if (cost !== null && cost >= 0) filledCount++;
            if (value !== null && value > 0) filledCount++;
            if (discount !== null && discount > 0 && discount <= 100) filledCount++;
            
            if (filledCount < 2) {
                if (validationMessage) validationMessage.style.display = 'block';
                return;
            } else {
                if (validationMessage) validationMessage.style.display = 'none';
            }
            
            if (filledCount === 2) {
                if (cost >= 0 && discount > 0 && discount <= 100 && (value === null || value <= 0)) {
                    // When cost and discount are provided, calculate value
                    if (discount === 100) {
                        // Handle division by zero case when discount is 100%
                        valueInput.value = cost > 0 ? (cost * 100).toFixed(2) : "0.00";
                    } else {
                        valueInput.value = (cost / (1 - discount / 100)).toFixed(2);
                    }
                } else if (cost >= 0 && value > 0 && (discount === null || discount <= 0 || discount > 100)) {
                    // When cost and value are provided, calculate discount
                    if (cost === 0) {
                        discountInput.value = "100.00";
                    } else {
                        discountInput.value = ((1 - cost / value) * 100).toFixed(2);
                    }
                } else if (value > 0 && discount > 0 && discount <= 100 && (cost === null || cost < 0)) {
                    // When value and discount are provided, calculate cost
                    costInput.value = (value * (1 - discount / 100)).toFixed(2);
                }
            } else if (filledCount === 3) {
                if (changedField === 'cost' && discount > 0 && discount <= 100 && value > 0) {
                    if (cost === 0) {
                        discountInput.value = "100.00";
                    } else {
                        discountInput.value = ((1 - cost / value) * 100).toFixed(2);
                    }
                } else if (changedField === 'value' && cost >= 0 && discount > 0 && discount <= 100) {
                    discountInput.value = cost === 0 ? "100.00" : ((1 - cost / value) * 100).toFixed(2);
                } else if (changedField === 'discount' && cost >= 0 && value > 0) {
                    if (discount === 100) {
                        costInput.value = "0.00";
                    } else {
                        costInput.value = (value * (1 - discount / 100)).toFixed(2);
                    }
                }
            }
        }
        
        valueInput.addEventListener('change', function() {
            updateFields('value');
        });
        costInput.addEventListener('change', function() {
            updateFields('cost');
        });
        discountInput.addEventListener('change', function() {
            updateFields('discount');
        });
        
        // Initial calculation
        updateFields(null);
    }
    
    // === Automatic formatting for MM/YY field ===
    function setupCardExpFormatting(fieldset) {
        const cardExpInput = fieldset.querySelector('.card-exp-input');
        if (cardExpInput) {
            cardExpInput.addEventListener('input', function(event) {
                let value = event.target.value.replace(/\D/g, ''); // Only digits
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                event.target.value = value;
            });
        }
    }

    function initializeCouponFieldset(fieldset, idx) {
        fieldset.dataset.index = idx;

        // FIX: Set correct selector for card info checkbox and container
        const includeCardInfoCheckbox = fieldset.querySelector(
            `#coupons-${idx}-include_card_info`
        );
        const cardFieldsContainer = fieldset.querySelector(
            `#card_fields_container_${idx}`
        );

        // FIX: Debug logging to check if elements are found
        console.log(`Fieldset ${idx}:`, {
            checkbox: includeCardInfoCheckbox,
            container: cardFieldsContainer
        });

        function toggleCardFields() {
            if (!includeCardInfoCheckbox || !cardFieldsContainer) {
                console.log(`Missing elements for fieldset ${idx}`);
                return;
            }
            
            console.log(`Toggling card fields for ${idx}. Checked:`, includeCardInfoCheckbox.checked);
            
            if (includeCardInfoCheckbox.checked) {
                cardFieldsContainer.style.display = 'block';
            } else {
                cardFieldsContainer.style.display = 'none';
                cardFieldsContainer.querySelectorAll('input').forEach(input => {
                    input.value = '';
                });
            }
        }

        if (includeCardInfoCheckbox && cardFieldsContainer) {
            // FIX: Remove any existing event listeners first to prevent duplicates
            includeCardInfoCheckbox.removeEventListener('change', toggleCardFields);
            
            // FIX: Add event listener with explicit binding
            includeCardInfoCheckbox.addEventListener('change', toggleCardFields);
            
            // FIX: Call immediately to set initial state
            toggleCardFields();
        }

        const companySelect = fieldset.querySelector('.company-select');
        const otherCompanyGroup = fieldset.querySelector('.other-company-group');

        function toggleOtherCompanyField() {
            if (companySelect.value === 'other') {
                otherCompanyGroup.style.display = 'block';
            } else {
                otherCompanyGroup.style.display = 'none';
                const input = otherCompanyGroup.querySelector('input');
                if (input) input.value = '';
            }
        }
        toggleOtherCompanyField();
        companySelect.addEventListener('change', toggleOtherCompanyField);

        // Add the new "BuyMe URL" field toggle
        const buymeCouponLinkGroup = fieldset.querySelector(`#buyme_coupon_link_group_${idx}`);

        function toggleBuymeCouponLinkField() {
            if (!buymeCouponLinkGroup) return;
            if (companySelect.value === '54') {  // assuming 54 is the ID for BuyMe
                buymeCouponLinkGroup.style.display = 'block';
            } else {
                buymeCouponLinkGroup.style.display = 'none';
                const buymeCouponLinkInput = buymeCouponLinkGroup.querySelector('input');
                if (buymeCouponLinkInput) {
                    buymeCouponLinkInput.value = '';
                }
            }
        }
        companySelect.addEventListener('change', toggleBuymeCouponLinkField);
        toggleBuymeCouponLinkField();

        const isOneTimeCheckbox = fieldset.querySelector('input[type="checkbox"][name$="-is_one_time"]');
        const purposeGroup = fieldset.querySelector('.purpose-field');

        function togglePurposeField() {
            if (isOneTimeCheckbox.checked) {
                purposeGroup.style.display = 'block';
            } else {
                purposeGroup.style.display = 'none';
                const input = purposeGroup.querySelector('input');
                if (input) input.value = '';
            }
        }
        togglePurposeField();
        isOneTimeCheckbox.addEventListener('change', togglePurposeField);

        const removeButton = fieldset.querySelector('.remove-coupon-button');
        if (removeButton) {
            removeButton.addEventListener('click', function() {
                fieldset.remove();
                updateLegends();
            });
        }

        const duplicateButton = fieldset.querySelector('.duplicate-coupon-button');
        if (duplicateButton) {
            duplicateButton.addEventListener('click', function() {
                duplicateCoupon(fieldset);
            });
        }
        
        // Set up calculations for this fieldset
        setupCalculations(fieldset);
        
        // Set up card expiration formatting
        setupCardExpFormatting(fieldset);
        
        // Set up tooltip functionality
        setupTooltips(fieldset);
    }
    
    // === Tooltip functionality ===
    function setupTooltips(fieldset) {
        const tooltipButtons = fieldset.querySelectorAll('.tooltip-button-mobile');
        
        tooltipButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tooltip = this.nextElementSibling.nextElementSibling;
                if (tooltip && tooltip.classList.contains('mobile-tooltip')) {
                    tooltip.style.display = 'block';
                }
            });
        });
        
        const closeButtons = fieldset.querySelectorAll('.close-tooltip');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tooltip = this.parentElement;
                tooltip.style.display = 'none';
            });
        });
    }

    function updateLegends() {
        const fieldsets = document.querySelectorAll('.coupon-fieldset');
        fieldsets.forEach(function(fieldset, idx) {
            fieldset.dataset.index = idx;
            updateFieldsetIndex(fieldset, idx);
        });
        index = fieldsets.length;
    }

    function updateFieldsetIndex(fieldset, newIndex) {
        const oldIndex = fieldset.dataset.index || '__INDEX__';
        const regex = new RegExp('(coupons-)(?:' + oldIndex + '|__INDEX__)(-)', 'g');

        fieldset.querySelectorAll('[name], [id], [for]').forEach(element => {
            if (element.name) {
                element.name = element.name.replace(regex, '$1' + newIndex + '$2');
                element.name = element.name.replace('___INDEX__', newIndex);
            }
            if (element.id) {
                element.id = element.id.replace(regex, '$1' + newIndex + '$2');
                element.id = element.id.replace('___INDEX__', newIndex);
                element.id = element.id.replace('__INDEX__', newIndex);
            }
            if (element.htmlFor) {
                element.htmlFor = element.htmlFor.replace(regex, '$1' + newIndex + '$2');
                element.htmlFor = element.htmlFor.replace('___INDEX__', newIndex);
                element.htmlFor = element.htmlFor.replace('__INDEX__', newIndex);
            }
        });

        fieldset.querySelectorAll('[id^="other_company_group_"], [id^="purpose_group_"]').forEach(element => {
            element.id = element.id.replace('_' + oldIndex, '_' + newIndex);
            element.id = element.id.replace('__INDEX__', newIndex);
            element.id = element.id.replace('___INDEX__', newIndex);
        });

        fieldset.querySelectorAll('[id^="card_fields_container_"]').forEach(element => {
            element.id = element.id.replace('_' + oldIndex, '_' + newIndex);
            element.id = element.id.replace('___INDEX__', newIndex);
            element.id = element.id.replace('__INDEX__', newIndex);
        });

        fieldset.querySelectorAll('[id^="buyme_coupon_link_group_"]').forEach(element => {
            element.id = element.id.replace('_' + oldIndex, '_' + newIndex);
            element.id = element.id.replace('__INDEX__', newIndex);
        });

        const legend = fieldset.querySelector('legend');
        if (legend) {
            legend.textContent = '×§×•×¤×•×Ÿ ' + (newIndex + 1);
        }
    }

    function duplicateCoupon(fieldset) {
        const container = document.getElementById('coupons-container');
        const clonedFieldset = fieldset.cloneNode(true);
        updateFieldsetIndex(clonedFieldset, index);

        const originalInputs = fieldset.querySelectorAll('input, select, textarea');
        const clonedInputs = clonedFieldset.querySelectorAll('input, select, textarea');
        clonedInputs.forEach((input, i) => {
            if (input.type === 'checkbox') {
                input.checked = originalInputs[i].checked;
            } else {
                input.value = originalInputs[i].value;
            }
        });

        initializeCouponFieldset(clonedFieldset, index);
        container.appendChild(clonedFieldset);
        index++;
        updateLegends();
    }

    function addCoupon() {
        const container = document.getElementById('coupons-container');
        const template = document.getElementById('coupon-template').content.cloneNode(true);
        const newFieldset = template.querySelector('.coupon-fieldset');

        updateFieldsetIndex(newFieldset, index);
        initializeCouponFieldset(newFieldset, index);
        container.appendChild(newFieldset);
        index++;
        updateLegends();
    }

    // Direct fix for potential empty fieldsets at the beginning
    function cleanEmptyFieldsets() {
        const container = document.getElementById('coupons-container');
        if (!container) return;
        
        const fieldsets = container.querySelectorAll('.coupon-fieldset');
        let emptyIndices = [];
        
        // Identify empty fieldsets
        fieldsets.forEach((fieldset, idx) => {
            const codeInput = fieldset.querySelector('input[name^="coupons-"][name$="-code"]');
            const codeValue = codeInput ? codeInput.value.trim() : '';
            
            const valueInput = fieldset.querySelector('input[name^="coupons-"][name$="-value"]');
            const valueValue = valueInput ? valueInput.value.trim() : '';
            
            // If the fieldset is effectively empty
            if (codeValue === '' && valueValue === '') {
                emptyIndices.push(idx);
            }
        });
        
        // Remove empty fieldsets (starting from the end to not mess up indices)
        for (let i = emptyIndices.length - 1; i >= 0; i--) {
            fieldsets[emptyIndices[i]].remove();
        }
        
        // If we removed any fieldsets, update the indices
        if (emptyIndices.length > 0) {
            updateLegends();
            console.log(`Removed ${emptyIndices.length} empty fieldsets and updated indices`);
        }
    }
    
    // Run cleaning immediately and after a short delay to catch any dynamic issues
    cleanEmptyFieldsets();
    setTimeout(cleanEmptyFieldsets, 500);

    const existingFieldsets = document.querySelectorAll('.coupon-fieldset');
    existingFieldsets.forEach(function(fieldset, idx) {
        initializeCouponFieldset(fieldset, idx);
    });

    // Add coupon button
    const addCouponButton = document.querySelector('.add-coupon-button');
    addCouponButton.addEventListener('click', function(event) {
        event.preventDefault();
        addCoupon();
    });

    // Attach event listeners to all open-modal buttons (admin-only)
    const openModalButtons = document.querySelectorAll('.open-modal-button');
    const modal = document.getElementById('urlModal');
    const closeModalButton = document.querySelector('.close-modal');
    const urlTextArea = document.getElementById('coupon-urls');

    openModalButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'block';
        });
    });

    if (closeModalButton) {
        closeModalButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }

    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Check expiration date and all required fields before form submission
    const couponsForm = document.getElementById('coupons-form');
    if (couponsForm) {
        couponsForm.addEventListener('submit', function(e) {
            // Clean any empty fieldsets first
            cleanEmptyFieldsets();
            
            // Check if there are any fieldsets left
            const fieldsets = document.querySelectorAll('.coupon-fieldset');
            if (fieldsets.length === 0) {
                e.preventDefault();
                alert('××™×Ÿ ×§×•×¤×•× ×™× ×œ×”×•×¡×¤×”. ×× × ×”×•×¡×£ ×œ×¤×—×•×ª ×§×•×¤×•×Ÿ ××—×“.');
                return;
            }
            
            // Now check if all required fields are populated
            let hasErrors = false;
            
            fieldsets.forEach((fieldset, idx) => {
                const companySelect = fieldset.querySelector('select[name^="coupons-"][name$="-company_id"]');
                const codeInput = fieldset.querySelector('input[name^="coupons-"][name$="-code"]');
                const valueInput = fieldset.querySelector('input[name^="coupons-"][name$="-value"]');
                const costInput = fieldset.querySelector('input[name^="coupons-"][name$="-cost"]');
                
                // Check required fields
                if (!companySelect || !companySelect.value || companySelect.value === "") {
                    console.error(`Coupon #${idx+1}: Missing company selection`);
                    hasErrors = true;
                }
                
                if (!codeInput || !codeInput.value.trim()) {
                    console.error(`Coupon #${idx+1}: Missing coupon code`);
                    hasErrors = true;
                }
                
                // Check that at least value and cost are filled
                const hasValue = valueInput && valueInput.value && valueInput.value.trim() !== "";
                const hasCost = costInput && costInput.value && costInput.value.trim() !== "";
                
                if (!hasValue || !hasCost) {
                    console.error(`Coupon #${idx+1}: Need both value and cost fields`);
                    hasErrors = true;
                }
                
                // Automatically calculate discount percentage if not set
                const discountInput = fieldset.querySelector('input[name^="coupons-"][name$="-discount_percentage"]');
                if (hasValue && hasCost && discountInput) {
                    const value = parseFloat(valueInput.value);
                    const cost = parseFloat(costInput.value);
                    
                    // Calculate discount only if it's not already set
                    if (!discountInput.value || discountInput.value === "0") {
                        if (cost === 0) {
                            discountInput.value = "100.00";
                        } else {
                            discountInput.value = ((1 - cost / value) * 100).toFixed(2);
                        }
                    }
                }
            });
            
            if (hasErrors) {
                e.preventDefault();
                alert('×—×œ×§ ××”×©×“×•×ª ×”× ×“×¨×©×™× ×—×¡×¨×™×. ×× × ×•×“× ×©×›×œ ×”×§×•×¤×•× ×™× ××›×™×œ×™×: ×—×‘×¨×”, ×§×•×“ ×§×•×¤×•×Ÿ, ×¢×¨×š ×§×•×¤×•×Ÿ ×•×¢×œ×•×ª.');
                return;
            }

            // Check for expired coupons
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let expiredCoupons = [];

            fieldsets.forEach((fieldset, idx) => {
                const expirationInput = fieldset.querySelector('input[type="date"][name^="coupons-"][name$="-expiration"]');
                if (expirationInput && expirationInput.value) {
                    const parts = expirationInput.value.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        const day = parseInt(parts[2]);
                        const selectedDate = new Date(year, month, day);
                        if (selectedDate <= today) {
                            const formattedDate = String(day).padStart(2, '0') + '/' + String(month + 1).padStart(2, '0') + '/' + year;
                            const companySelect = fieldset.querySelector('.company-select');
                            const companyName = companySelect ? companySelect.options[companySelect.selectedIndex].text : 'Unknown';
                            const codeInput = fieldset.querySelector('input[name^="coupons-"][name$="-code"]');
                            const couponCode = codeInput ? codeInput.value : 'Unknown';
                            const valueInput = fieldset.querySelector('input[name^="coupons-"][name$="-value"]');
                            const couponValue = valueInput ? valueInput.value : 'Unknown';
                            expiredCoupons.push(
                                "ğŸ“Œ Coupon #" + (idx+1) + ":\n" +
                                "- ğŸ¢ Company: " + companyName + "\n" +
                                "- ğŸ”¢ Coupon Code: " + couponCode + "\n" +
                                "- ğŸ’° Value: " + couponValue + "\n" +
                                "- â³ Expiration: " + formattedDate
                            );
                        }
                    }
                }
            });

            if (expiredCoupons.length > 0) {
                const confirmMsg = 
                    "âš ï¸ Attention! The following coupons have an expiration date that is either today or has passed:\n\n" +
                    expiredCoupons.join("\n\n") +
                    "\n\nâ“ Do you still want to continue?";
                if (!confirm(confirmMsg)) {
                    e.preventDefault();
                }
            }
        });
    }
}

// Fix for BuyMe coupon import validation issues
document.addEventListener('DOMContentLoaded', function() {
    const fixBuymeCouponResponse = () => {
        const container = document.getElementById('coupons-container');
        if (!container) return;
        
        // Step 1: Find and remove any empty fieldsets at the beginning
        const fieldsets = container.querySelectorAll('.coupon-fieldset');
        let emptyFieldsetsRemoved = false;
        
        fieldsets.forEach((fieldset, idx) => {
            const codeInput = fieldset.querySelector('input[name^="coupons-"][name$="-code"]');
            const codeValue = codeInput ? codeInput.value.trim() : '';
            
            // If this is an empty fieldset (only has company ID set) - remove it
            if (!codeValue) {
                fieldset.remove();
                emptyFieldsetsRemoved = true;
                console.log(`Removed empty fieldset at index ${idx}`);
            }
        });
        
        // Step 2: If we removed fieldsets, update all indices
        if (emptyFieldsetsRemoved) {
            const remainingFieldsets = container.querySelectorAll('.coupon-fieldset');
            remainingFieldsets.forEach((fieldset, newIdx) => {
                // Update data-index
                fieldset.dataset.index = newIdx;
                
                // Update all name, id, and for attributes
                fieldset.querySelectorAll('[name^="coupons-"], [id^="coupons-"], [for^="coupons-"]').forEach(el => {
                    const pattern = /^(coupons-)\d+(-.*)/;
                    
                    if (el.name) {
                        el.name = el.name.replace(pattern, `$1${newIdx}$2`);
                    }
                    if (el.id) {
                        el.id = el.id.replace(pattern, `$1${newIdx}$2`);
                    }
                    if (el.htmlFor) {
                        el.htmlFor = el.htmlFor.replace(pattern, `$1${newIdx}$2`);
                    }
                });
                
                // Update special IDs (containers, etc.)
                fieldset.querySelectorAll('[id^="other_company_group_"], [id^="purpose_group_"], [id^="buyme_coupon_link_group_"], [id^="card_fields_container_"]').forEach(el => {
                    const parts = el.id.split('_');
                    if (parts.length >= 3) {
                        // Rebuild ID with new index
                        const baseId = parts.slice(0, -1).join('_');
                        el.id = `${baseId}_${newIdx}`;
                    }
                });
                
                // Update legend text
                const legend = fieldset.querySelector('legend');
                if (legend) {
                    legend.textContent = `×§×•×¤×•×Ÿ ${newIdx + 1}`;
                }
                
                // Special handling for BuyMe coupons - automatically set discount_percentage to 100 if cost is 0
                const valueInput = fieldset.querySelector('input[name^="coupons-"][name$="-value"]');
                const costInput = fieldset.querySelector('input[name^="coupons-"][name$="-cost"]');
                const discountInput = fieldset.querySelector('input[name^="coupons-"][name$="-discount_percentage"]');
                
                if (valueInput && costInput && discountInput) {
                    const value = parseFloat(valueInput.value) || 0;
                    const cost = parseFloat(costInput.value) || 0;
                    
                    // If we have a value but cost is 0, set discount to 100%
                    if (value > 0 && cost === 0) {
                        discountInput.value = "100";
                        console.log(`Set discount to 100% for fieldset ${newIdx} (value: ${value}, cost: ${cost})`);
                    }
                    // Otherwise calculate proper discount
                    else if (value > 0 && cost > 0) {
                        const discount = ((value - cost) / value) * 100;
                        discountInput.value = discount.toFixed(2);
                        console.log(`Calculated discount ${discount.toFixed(2)}% for fieldset ${newIdx}`);
                    }
                }
            });
            
            console.log(`Fixed indices for ${remainingFieldsets.length} fieldsets`);
        }
    };
    
    // Run the fix when the page loads, and again after a short delay
    fixBuymeCouponResponse();
    setTimeout(fixBuymeCouponResponse, 500);
    
    // Modify the form submission to also validate and fix discount percentages
    const originalSubmitUrls = document.getElementById('submitUrls');
    if (originalSubmitUrls) {
        const originalClick = originalSubmitUrls.onclick;
        originalSubmitUrls.onclick = null;
        
        originalSubmitUrls.addEventListener('click', async function(event) {
            // Call the original handler
            if (originalClick) {
                await originalClick.call(this, event);
            }
            
            // Apply our fix after a small delay to ensure the DOM has been updated
            setTimeout(fixBuymeCouponResponse, 1000);
        });
    }
    
    // Also add pre-submission validation to ensure discount percentages are properly set
    const couponsForm = document.getElementById('coupons-form');
    if (couponsForm) {
        couponsForm.addEventListener('submit', function(e) {
            const fieldsets = document.querySelectorAll('.coupon-fieldset');
            
            fieldsets.forEach((fieldset, idx) => {
                const valueInput = fieldset.querySelector('input[name^="coupons-"][name$="-value"]');
                const costInput = fieldset.querySelector('input[name^="coupons-"][name$="-cost"]');
                const discountInput = fieldset.querySelector('input[name^="coupons-"][name$="-discount_percentage"]');
                
                if (valueInput && costInput && discountInput) {
                    const value = parseFloat(valueInput.value) || 0;
                    const cost = parseFloat(costInput.value) || 0;
                    
                    // If value exists and cost is 0, set discount to 100%
                    if (value > 0 && cost === 0) {
                        discountInput.value = "100";
                    }
                    // Otherwise calculate proper discount
                    else if (value > 0 && cost > 0) {
                        const discount = ((value - cost) / value) * 100;
                        discountInput.value = discount.toFixed(2);
                    }
                }
            });
        }, true); // Use capturing phase to run before other handlers
    }
}););

// Handle URL submissions for BuyMe coupons
document.getElementById('submitUrls')?.addEventListener('click', async function () {
    const textarea = document.getElementById('coupon-urls');
    const rawText = textarea.value.trim();

    if (!rawText) {
        alert("×œ× ×”×•×–× ×• ×§×™×©×•×¨×™×.");
        return;
    }

    const urls = rawText
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

    // Get CSRF Token from <meta>
    const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
    if (!csrfTokenElement) {
        alert("CSRF token ×œ× × ××¦× ×‘×¢××•×“.");
        return;
    }
    const csrfToken = csrfTokenElement.getAttribute('content');
    
    // Show loading indicator
    const submitButton = document.getElementById('submitUrls');
    const originalText = submitButton.textContent;
    submitButton.textContent = "××¢×‘×“ ×§×•×¤×•× ×™×...";
    submitButton.disabled = true;
    
    const modal = document.getElementById('urlModal');

    try {
        const response = await fetch('/submit_buyme_coupon_urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ urls: urls })
        });

        const contentType = response.headers.get("Content-Type");

        // Handle HTML response (which contains the form)
        if (response.ok && contentType && contentType.includes("text/html")) {
            // First, we'll close the modal and clear the textarea
            modal.style.display = 'none';
            textarea.value = '';
            
            // Get the HTML response
            const html = await response.text();
            
            // Create a temporary container to parse the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // We'll modify the DOM to remove any empty fieldsets before displaying
            const formInResponse = tempDiv.querySelector('#coupons-form');
            if (formInResponse) {
                // Find all fieldsets
                const fieldsets = formInResponse.querySelectorAll('.coupon-fieldset');
                
                // Identify empty fieldsets
                let emptyIndices = [];
                fieldsets.forEach((fieldset, idx) => {
                    const codeInput = fieldset.querySelector('input[name^="coupons-"][name$="-code"]');
                    const codeValue = codeInput ? codeInput.value : '';
                    
                    const valueInput = fieldset.querySelector('input[name^="coupons-"][name$="-value"]');
                    const valueValue = valueInput ? valueInput.value : '';
                    
                    // Check if this fieldset is effectively empty
                    if (!codeValue || !valueValue) {
                        emptyIndices.push(idx);
                    }
                });
                
                // Remove empty fieldsets (starting from the end to not affect indices)
                for (let i = emptyIndices.length - 1; i >= 0; i--) {
                    const index = emptyIndices[i];
                    if (fieldsets[index]) {
                        fieldsets[index].remove();
                    }
                }
                
                // Update the indices of the remaining fieldsets
                const remainingFieldsets = formInResponse.querySelectorAll('.coupon-fieldset');
                remainingFieldsets.forEach((fieldset, idx) => {
                    // Set the data-index attribute
                    fieldset.dataset.index = idx;
                    
                    // Update all the input, label, and id references
                    fieldset.querySelectorAll('[name^="coupons-"], [id^="coupons-"], [for^="coupons-"]').forEach(el => {
                        // Match the pattern like coupons-X-field
                        const pattern = /^(coupons-)\d+(-.*)/;
                        
                        if (el.name) {
                            el.name = el.name.replace(pattern, `$1${idx}$2`);
                        }
                        if (el.id) {
                            el.id = el.id.replace(pattern, `$1${idx}$2`);
                        }
                        if (el.htmlFor) {
                            el.htmlFor = el.htmlFor.replace(pattern, `$1${idx}$2`);
                        }
                    });
                    
                    // Update other specific elements that have indices
                    fieldset.querySelectorAll('[id^="other_company_group_"], [id^="purpose_group_"], [id^="buyme_coupon_link_group_"], [id^="card_fields_container_"]').forEach(el => {
                        const baseId = el.id.split('_')[0] + '_' + el.id.split('_')[1] + '_';
                        el.id = baseId + idx;
                    });
                    
                    // Update the legend text
                    const legend = fieldset.querySelector('legend');
                    if (legend) {
                        legend.textContent = `×§×•×¤×•×Ÿ ${idx + 1}`;
                    }
                });
                
                // Log the cleaning result
                if (emptyIndices.length > 0) {
                    console.log(`Removed ${emptyIndices.length} empty fieldsets from response HTML`);
                }
                
                // Update the form's HTML with our cleaned version
                const formContainer = document.getElementById('coupons-form').parentNode;
                formContainer.innerHTML = formInResponse.outerHTML;
                
                // Now we need to re-initialize our event listeners on the new HTML
                document.dispatchEvent(new Event('DOMContentLoaded'));
            } else {
                // If we couldn't find the form, just render the response as is
                document.open();
                document.write(html);
                document.close();
            }
        } else if (response.ok && contentType && contentType.includes("application/json")) {
            const data = await response.json();
            modal.style.display = 'none';
            textarea.value = '';
            
            if (data.added_coupons && data.added_coupons.length > 0) {
                let successMsg = `× ×•×¡×¤×• ×‘×”×¦×œ×—×” ${data.added_coupons.length} ×§×•×¤×•× ×™×!`;
                
                if (data.failed_coupons && data.failed_coupons.length > 0) {
                    successMsg += `\n(${data.failed_coupons.length} ×§×•×¤×•× ×™× × ×›×©×œ×• ×‘×”×•×¡×¤×”)`;
                }
                
                alert(successMsg);
                // Redirect to show coupons page
                window.location.href = '/show_coupons';
            } else if (data.failed_coupons && data.failed_coupons.length > 0) {
                alert(`×œ× × ×•×¡×¤×• ×§×•×¤×•× ×™×. ${data.failed_coupons.length} ×§×•×¤×•× ×™× × ×›×©×œ×• ×‘×”×•×¡×¤×”.`);
                console.error("Failed coupons:", data.failed_coupons);
            } else {
                alert("×œ× × ×•×¡×¤×• ×§×•×¤×•× ×™×. × × ×œ×‘×“×•×§ ××ª ×”×§×™×©×•×¨×™× ×•×œ× ×¡×•×ª ×©×•×‘.");
            }
        } else {
            // Handle error response
            let errorMsg = "×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×¤×•× ×™×.";
            if (contentType && contentType.includes("application/json")) {
                const errorData = await response.json();
                errorMsg = errorData.message || errorMsg;
            } else if (contentType && contentType.includes("text/html")) {
                errorMsg = "×©×’×™××ª ×©×¨×ª. × × ×œ×‘×“×•×§ ××ª ×”×œ×•×’×™×.";
            }
            alert(errorMsg);
        }
    } catch (error) {
        console.error("Error:", error);
        alert("×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×™×©×•×¨×™×: " + error.message);
    } finally {
        // Restore button
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    }
</script>

{% endblock %}