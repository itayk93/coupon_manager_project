<!-- /app/templates/review_usage_modal.html -->
<span class="close-modal">&times;</span>
<h2>××™×©×•×¨ ×©×™××•×©×™× ×©××•×ª×¨×•</h2>

<form id="reviewUsageForm" method="POST" action="{{ url_for('coupons.process_review_form') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <table class="usage-table">
        <thead>
            <tr>
                <th>×¡×™××•×Ÿ</th>
                <th>×—×‘×¨×” ×©×–×•×”×ª×”</th>
                <th>×§×•×¤×•×Ÿ</th>
                <th>×›××” ×”×©×ª××©×ª</th>
            </tr>
        </thead>
        <tbody>
        {% for row in usage_list %}
            <tr>
                <!-- ×¢××•×“×” 1: ×¡×™××•×Ÿ -->
                <td>
                    <input type="checkbox"
                           name="row-{{ loop.index0 }}-checked"
                           value="yes"
                           checked
                           class="usage-checkbox">
                </td>
                <!-- ×¢××•×“×” 2: ×©× ×”×—×‘×¨×” ×›×¤×™ ×©×”-GPT ×–×™×”×” -->
                <td>{{ row.company }}</td>
                <!-- ×¢××•×“×” 3: ×‘×—×™×¨×ª ×”×§×•×¤×•×Ÿ ×©×œ ×”××©×ª××© -->
                <td>
                    <select name="row-{{ loop.index0 }}-company" class="coupon-select">
                        {% for cpn in row.matched_coupons %}
                            <option value="{{ cpn.id }}"
                                    data-remaining="{{ '%.2f' | format(cpn.remaining_balance) }}"
                                    {% if loop.first %}selected{% endif %}>
                                {{ cpn.company }} ({{ cpn.code }}) - × ×•×ª×¨: {{ '%.2f' | format(cpn.remaining_balance) }} â‚ª
                            </option>
                        {% endfor %}
                        <option value="other">ğŸ“Œ ×‘×—×¨ ×§×•×¤×•×Ÿ ××—×¨...</option>
                    </select>
                </td>
                <!-- ×¢××•×“×” 4: ×¡×›×•× ×”×©×™××•×© ×•×”×›×¤×ª×•×¨ "× ×•×¦×œ" ×‘×ª×•×š ×”×§×œ×˜ -->
                <td>
                    <div class="amount-wrapper">
                        <input type="text"
                               name="row-{{ loop.index0 }}-amount"
                               value="{{ '%.2f' | format(row.amount_used or 0) }}"
                               class="amount-input">
                        <button type="button" class="btn-used">× ×™×¦×•×œ ××œ×</button>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
    <div class="modal-actions">
        <button type="button" class="cancel-button">×‘×™×˜×•×œ</button>
        <button type="submit" class="submit-button">××™×©×•×¨</button>
    </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // ×”××–× ×” ×œ×›×¤×ª×•×¨ "× ×•×¦×œ ××œ×"
    document.querySelectorAll(".btn-used").forEach(function(button) {
        button.addEventListener("click", function() {
            const row = this.closest("tr");
            const selectElem = row.querySelector(".coupon-select");
            const selectedOption = selectElem.options[selectElem.selectedIndex];
            const remainingAmount = parseFloat(selectedOption.getAttribute("data-remaining")).toFixed(2);
            const amountInput = row.querySelector(".amount-input");

            if (remainingAmount !== null) {
                amountInput.value = remainingAmount;
            }
        });
    });

    // ×”××–× ×” ×œ×›×¤×ª×•×¨ ×¡×’×™×¨×”
    document.querySelector(".close-modal").addEventListener("click", function() {
        const modal = document.getElementById("usageReportModal");
        if (modal) modal.classList.remove("active");
    });

    // ×”××–× ×” ×œ×›×¤×ª×•×¨ ×‘×™×˜×•×œ
    document.querySelector(".cancel-button").addEventListener("click", function() {
        const modal = document.getElementById("usageReportModal");
        if (modal) modal.classList.remove("active");
    });

    // ×”×’×©×ª ×”×˜×•×¤×¡ ×¢× AJAX
    document.getElementById("reviewUsageForm").addEventListener("submit", function(e) {
        e.preventDefault();
        
        // ××™×¡×•×£ × ×ª×•× ×™× ××”×˜×•×¤×¡
        const formData = new FormData(this);
        
        // ×©×œ×™×—×ª ×”× ×ª×•× ×™× ×‘-AJAX
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // ×¡×’×™×¨×ª ×”××•×“×œ
            const modal = document.getElementById("usageReportModal");
            if (modal) modal.classList.remove("active");
            
            // ×”×¦×’×ª ×”×•×“×¢×ª ×”×¦×œ×—×”
            if (data.success) {
                // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”×’×œ×•×‘×œ×™×ª ×œ×”×¦×’×ª ×”×•×“×¢×”
                if (typeof showFlashMessage === 'function') {
                    showFlashMessage(data.message, 'success');
                    
                    // ×”×¦×’×ª ×¨×©×™××ª ×¢×“×›×•× ×™× ××•×¦×œ×—×™×
                    if (data.successes && data.successes.length) {
                        data.successes.forEach(success => {
                            setTimeout(() => {
                                showFlashMessage(success, 'success');
                            }, 500);
                        });
                    }
                } else {
                    alert(data.message);
                }
            } else {
                if (typeof showFlashMessage === 'function') {
                    showFlashMessage(data.message || '××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×¢×“×›×•×Ÿ ×”×©×™××•×©×™×', 'error');
                } else {
                    alert(data.message || '××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×¢×“×›×•×Ÿ ×”×©×™××•×©×™×');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showFlashMessage === 'function') {
                showFlashMessage('××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×©×œ×™×—×ª ×”×˜×•×¤×¡', 'error');
            } else {
                alert('××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×©×œ×™×—×ª ×”×˜×•×¤×¡');
            }
        });
    });
});
</script>